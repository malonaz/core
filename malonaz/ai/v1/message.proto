syntax = "proto3";

package malonaz.ai.v1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "malonaz/ai/v1/tool.proto";

option go_package = "github.com/malonaz/core/genproto/ai/v1";

// Wrapper message representing any message type in a multi-turn conversation.
// Use this when building conversation histories or streaming message sequences.
message Message {
  option (buf.validate.message).cel = {
    id: "system_role_blocks"
    message: "SYSTEM messages can only have text blocks"
    expression: "this.role != 1 || this.blocks.all(b, has(b.text))"
  };
  option (buf.validate.message).cel = {
    id: "assistant_role_blocks"
    message: "ASSISTANT messages can only have thought, text, tool_call, partial_tool_call, or image blocks"
    expression: "this.role != 2 || this.blocks.all(b, has(b.thought) || has(b.text) || has(b.tool_call) || has(b.image))"
  };
  option (buf.validate.message).cel = {
    id: "user_role_blocks"
    message: "USER messages can only have text or image blocks"
    expression: "this.role != 3 || this.blocks.all(b, has(b.text) || has(b.image))"
  };
  option (buf.validate.message).cel = {
    id: "tool_role_blocks"
    message: "TOOL messages can only have tool_result blocks"
    expression: "this.role != 4 || this.blocks.all(b, has(b.tool_result))"
  };

  // When this message was created.
  google.protobuf.Timestamp create_time = 1;

  // Arbitrary key-value metadata associated with the message.
  map<string, string> metadata = 2;

  // Role of the message sender.
  Role role = 3 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];

  // Blocks created by the assistant.
  repeated Block blocks = 4;
}

// A block of content within a message.
message Block {
  option (buf.validate.message).cel = {
    id: "block_content_required_when_signature_set"
    message: "content is required when signature is set"
    expression: "this.signature == '' || has(this.thought) || has(this.text) || has(this.tool_call) || has(this.partial_tool_call) || has(this.tool_result) || has(this.image)"
  };

  // Index of this block.
  int64 index = 1;

  // A signature for this block.
  string signature = 2;

  // Provider specific extra fields.
  google.protobuf.Struct extra_fields = 3;

  // The content type.
  oneof content {
    // Thought block.
    string thought = 4;

    // Text block.
    string text = 5;

    // Tool call block.
    ToolCall tool_call = 6;

    // Partial tool call block.
    ToolCall partial_tool_call = 7;

    // Tool result block.
    ToolResult tool_result = 8;

    // Image block.
    Image image = 9;
  }
}

// An image block.
message Image {
  option (buf.validate.message).cel = {
    id: "image_requires_media_type_for_data"
    message: "media_type is required when using data"
    expression: "!has(this.data) || this.media_type != ''"
  };

  // The image source.
  oneof source {
    option (buf.validate.oneof).required = true;

    // Raw image bytes.
    bytes data = 1;

    // URL to the image. Supports both HTTPS URLs and data URLs
    // (e.g., "data:image/png;base64,...").
    string url = 2;
  }

  // MIME type of the image (e.g., "image/png", "image/jpeg", "image/webp", "image/gif").
  // Required when using `data`, optional when using `url`.
  string media_type = 3;

  // Quality of the image.
  ImageQuality quality = 4 [(buf.validate.field).enum.defined_only = true];
}

// Represents the level of reasoning effort for AI model responses.
// Controls how many internal reasoning tokens the model generates before
// producing its final response. Higher effort yields more thorough reasoning
// at the cost of increased latency and token usage.
enum ReasoningEffort {
  // Unspecified reasoning effort. Should not be used explicitly.
  REASONING_EFFORT_UNSPECIFIED = 0;

  // Default reasoning effort as configured by the platform.
  REASONING_EFFORT_DEFAULT = 1;

  // Low reasoning effort.
  // Prioritizes speed and token efficiency with minimal internal reasoning.
  // Best for simple, straightforward queries.
  REASONING_EFFORT_LOW = 2;

  // Medium reasoning effort.
  // Balances response speed with reasoning thoroughness.
  // Suitable for most general-purpose queries.
  REASONING_EFFORT_MEDIUM = 3;

  // High reasoning effort.
  // Maximizes reasoning depth and accuracy by generating more thinking tokens.
  // Best for complex problems requiring careful analysis.
  // May result in slower responses and higher token consumption.
  REASONING_EFFORT_HIGH = 4;
}

// Represents the role of a message in a multi-turn AI conversation.
enum Role {
  // Used to detect an unset field.
  ROLE_UNSPECIFIED = 0;
  // System message.
  ROLE_SYSTEM = 1;
  // Assistant message.
  ROLE_ASSISTANT = 2;
  // User message.
  ROLE_USER = 3;
  // User message.
  ROLE_TOOL = 4;
}

// Controls the fidelity level for image processing in vision requests.
enum ImageQuality {
  // Unspecified quality. The provider will use its default setting.
  IMAGE_QUALITY_UNSPECIFIED = 0;
  // Automatic quality selection based on image size and content.
  IMAGE_QUALITY_AUTO = 1;
  // Low fidelity processing for faster, cheaper responses.
  IMAGE_QUALITY_LOW = 2;
  // High fidelity processing for detailed image analysis.
  IMAGE_QUALITY_HIGH = 3;
}
