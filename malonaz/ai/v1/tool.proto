syntax = "proto3";

package malonaz.ai.v1;

import "buf/validate/validate.proto";
import "google/protobuf/struct.proto";
import "google/rpc/status.proto";
import "malonaz/json/v1/schema.proto";

option go_package = "github.com/malonaz/core/genproto/ai/v1";

// Represents a tool that can be called by the AI model.
message Tool {
  // A unique name for this tool.
  string name = 1 [(buf.validate.field).required = true];

  // A description of what the tool does.
  string description = 2 [(buf.validate.field).required = true];

  // The json schema of the expected object to be returned.
  malonaz.json.v1.Schema json_schema = 3;

  // Annotations about this tool (not transmitted to the ai provider).
  // This should be used by tooling.
  // All annotations are inherited by any tool call created by this tool.
  map<string, string> annotations = 4;
}

// A tool call that the model wants to invoke.
message ToolCall {
  // The id of this tool call.
  string id = 1 [(buf.validate.field).required = true];

  // The name of the tool to call.
  string name = 2 [(buf.validate.field).required = true];

  // The arguments to call the tool with.
  google.protobuf.Struct arguments = 3 [(buf.validate.field).required = true];

  // Provider specific extra fields.
  google.protobuf.Struct extra_fields = 4;

  // Annotations populated from the tool that created this tool call.
  map<string, string> annotations = 5;

  // If true, this is a partial tool call.
  bool partial = 6;
}

// The result of executing a tool call.
message ToolResult {
  // Name of the tool that created this result.
  string tool_name = 1;

  // ID of the tool call this message is responding to.
  string tool_call_id = 2;

  // The outcome of the tool execution.
  oneof result {
    option (buf.validate.oneof).required = true;

    // The output returned by the tool execution.
    // May contain structured data (e.g., JSON) or plain text depending on the tool.
    string content = 3;

    // The output returned by the tool execution as structured data.
    google.protobuf.Value structured_content = 4;

    // Error if the tool execution failed.
    google.rpc.Status error = 5;
  }
}

// Controls which tool(s) the model should use.
message ToolChoice {
  option (buf.validate.message).cel = {
    id: "ai.v1.ToolChoice.mode_not_unspecified"
    message: "mode cannot be TOOL_CHOICE_MODE_UNSPECIFIED"
    expression: "!has(this.mode) || this.mode != 0"
  };

  // The choice.
  oneof choice {
    option (buf.validate.oneof).required = true;

    // Let the model decide whether to call a tool.
    ToolChoiceMode mode = 1 [(buf.validate.field).enum.defined_only = true];

    // Force the model to call a specific tool by name.
    string tool_name = 2;
  }
}

// Mode for tool choice.
enum ToolChoiceMode {
  // Used to detect an unset field.
  TOOL_CHOICE_MODE_UNSPECIFIED = 0;

  // Do not use any tool.
  TOOL_CHOICE_MODE_NONE = 1;

  // Let the model decide whether to call a tool.
  TOOL_CHOICE_MODE_AUTO = 2;

  // Require the model to call at least one tool.
  TOOL_CHOICE_MODE_REQUIRED = 3;
}
