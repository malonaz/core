// Code generated by protoc-templates. DO NOT EDIT.
// source: malonaz/ai/v1/chat.proto
package model

import (
	json "encoding/json"
	errors "errors"
	fmt "fmt"
	v1 "github.com/malonaz/core/genproto/ai/v1"
	pbutil "github.com/malonaz/core/go/pbutil"
	resourcename "go.einride.tech/aip/resourcename"
	timestamppb "google.golang.org/protobuf/types/known/timestamppb"
	time "time"
)

var (
	ErrChatAlreadyExists  = errors.New("chat already exists")
	ErrChatNotExist       = errors.New("chat does not exist")
	ErrChatAlreadyDeleted = errors.New("chat already deleted")
	ErrChatETagChanged    = errors.New("chat etag changed")
)

type Chat struct {
	OrganizationID string `db:"organization_id"`

	UserID string `db:"user_id"`

	ChatID string `db:"chat_id"`

	CreateTime time.Time  `db:"create_time"`
	UpdateTime time.Time  `db:"update_time"`
	DeleteTime *time.Time `db:"delete_time"`
	Etag       string     `db:"etag"`
	Labels     []byte     `db:"labels"`
	Metadata   []byte     `db:"metadata"`
}

func ChatFromPb(m *v1.Chat) (*Chat, error) {
	if m.Name == "" {
		return nil, fmt.Errorf("FromPb requires `name` to be set")
	}

	OrganizationID, UserID, ChatID, err := ParseChatName(m.Name)
	if err != nil {
		return nil, err
	}

	if err := m.CreateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating create_time: %w", err)
	}

	if err := m.UpdateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating update_time: %w", err)
	}

	var DeleteTime *time.Time
	if m.DeleteTime != nil {

		if err := m.DeleteTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating delete_time: %w", err)
		}
		t := m.DeleteTime.AsTime()
		DeleteTime = &t
	}

	var LabelsBytes []byte
	if m.Labels != nil {
		var err error
		LabelsBytes, err = json.Marshal(m.Labels)
		if err != nil {
			return nil, fmt.Errorf("marshaling Labels: %w", err)
		}
	}

	if m.Metadata == nil {
		return nil, fmt.Errorf("Metadata cannot be nil")
	}
	MetadataBytes, err := pbutil.Marshal(m.Metadata)
	if err != nil {
		return nil, fmt.Errorf("marshaling Metadata: %w", err)
	}

	return &Chat{
		OrganizationID: OrganizationID,
		UserID:         UserID,
		ChatID:         ChatID,

		CreateTime: m.CreateTime.AsTime(),
		UpdateTime: m.UpdateTime.AsTime(),
		DeleteTime: DeleteTime,
		Etag:       m.Etag,
		Labels:     LabelsBytes,
		Metadata:   MetadataBytes,
	}, nil
}

func (m *Chat) ToPb() (*v1.Chat, error) {

	var CreateTime *timestamppb.Timestamp
	CreateTime = timestamppb.New(m.CreateTime)
	if err := CreateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating create_time: %w", err)
	}

	var UpdateTime *timestamppb.Timestamp
	UpdateTime = timestamppb.New(m.UpdateTime)
	if err := UpdateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating update_time: %w", err)
	}

	var DeleteTime *timestamppb.Timestamp
	if m.DeleteTime != nil {
		DeleteTime = timestamppb.New(*m.DeleteTime)
		if err := DeleteTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating delete_time: %w", err)
		}
	}

	var Labels map[string]string
	if m.Labels != nil {
		Labels = map[string]string{}
		if err := json.Unmarshal(m.Labels, &Labels); err != nil {
			return nil, fmt.Errorf("marshaling Labels: %w", err)
		}
	}
	Metadata := &v1.ChatMetadata{}
	if err := pbutil.Unmarshal(m.Metadata, Metadata); err != nil {
		return nil, fmt.Errorf("marshaling Metadata: %w", err)
	}

	name := resourcename.Sprint("organizations/{organization}/users/{user}/chats/{chat}", m.OrganizationID, m.UserID, m.ChatID)
	if err := resourcename.Validate(name); err != nil {
		return nil, fmt.Errorf("validating resource name: %w", err)
	}
	return &v1.Chat{
		Name: name,

		CreateTime: CreateTime,
		UpdateTime: UpdateTime,
		DeleteTime: DeleteTime,
		Etag:       m.Etag,
		Labels:     Labels,
		Metadata:   Metadata,
	}, nil
}

func ParseChatName(name string) (string, string, string, error) {
	var OrganizationID, UserID, ChatID string
	if err := resourcename.Sscan(name, "organizations/{organization}/users/{user}/chats/{chat}", &OrganizationID, &UserID, &ChatID); err != nil {
		return "", "", "", fmt.Errorf("parsing resource name: %v", err)
	}
	return OrganizationID, UserID, ChatID, nil
}
