// Code generated by protoc-templates. DO NOT EDIT.
// source: proto/scheduler/v1/job.proto
package model

import (
	json "encoding/json"
	fmt "fmt"
	v1 "github.com/malonaz/core/genproto/scheduler/v1"
	pbutil "github.com/malonaz/core/go/pbutil"
	postgres "github.com/malonaz/core/go/postgres"
	resourcename "go.einride.tech/aip/resourcename"
	anypb "google.golang.org/protobuf/types/known/anypb"
	timestamppb "google.golang.org/protobuf/types/known/timestamppb"
	time "time"
)

var JobColumns = postgres.GetDBColumns(Job{})

type Job struct {
	JobID string `db:"id"`

	CreateTime    time.Time  `db:"created_at"`
	StartTime     *time.Time `db:"started_at"`
	ScheduleTime  *time.Time `db:"scheduled_for"`
	CompleteTime  *time.Time `db:"processed_at"`
	LockTime      *time.Time `db:"locked_until"`
	Payload       []byte     `db:"payload"`
	Metadata      []byte     `db:"metadata"`
	AttemptCount  int32      `db:"consumed_count"`
	FailureReason *string    `db:"error_detail"`
}

func JobFromPb(proto *v1.Job) (*Job, error) {
	if proto.Name == "" {
		return nil, fmt.Errorf("FromPb requires `name` to be set")
	}

	JobID, err := ParseJobName(proto.Name)
	if err != nil {
		return nil, err
	}

	if err := proto.CreateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating create_time: %w", err)
	}

	var StartTime *time.Time
	if proto.StartTime != nil {

		if err := proto.StartTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating start_time: %w", err)
		}
		t := proto.StartTime.AsTime()
		StartTime = &t
	}

	var ScheduleTime *time.Time
	if proto.ScheduleTime != nil {

		if err := proto.ScheduleTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating schedule_time: %w", err)
		}
		t := proto.ScheduleTime.AsTime()
		ScheduleTime = &t
	}

	var CompleteTime *time.Time
	if proto.CompleteTime != nil {

		if err := proto.CompleteTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating complete_time: %w", err)
		}
		t := proto.CompleteTime.AsTime()
		CompleteTime = &t
	}

	var LockTime *time.Time
	if proto.LockTime != nil {

		if err := proto.LockTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating lock_time: %w", err)
		}
		t := proto.LockTime.AsTime()
		LockTime = &t
	}

	if proto.Payload == nil {
		return nil, fmt.Errorf("Payload cannot be nil")
	}
	PayloadBytes, err := pbutil.Marshal(proto.Payload)
	if err != nil {
		return nil, fmt.Errorf("marshaling Payload: %w", err)
	}

	if proto.Metadata == nil {
		return nil, fmt.Errorf("Metadata cannot be nil")
	}
	MetadataBytes, err := json.Marshal(proto.Metadata)
	if err != nil {
		return nil, fmt.Errorf("marshaling Metadata: %w", err)
	}

	var FailureReason *string
	if proto.FailureReason != "" {
		FailureReason = &proto.FailureReason
	}

	return &Job{
		JobID: JobID,

		CreateTime:    proto.CreateTime.AsTime(),
		StartTime:     StartTime,
		ScheduleTime:  ScheduleTime,
		CompleteTime:  CompleteTime,
		LockTime:      LockTime,
		Payload:       PayloadBytes,
		Metadata:      MetadataBytes,
		AttemptCount:  proto.AttemptCount,
		FailureReason: FailureReason,
	}, nil
}

func (m *Job) ToPb() (*v1.Job, error) {

	var CreateTime *timestamppb.Timestamp
	CreateTime = timestamppb.New(m.CreateTime)
	if err := CreateTime.CheckValid(); err != nil {
		return nil, fmt.Errorf("validating create_time: %w", err)
	}

	var StartTime *timestamppb.Timestamp
	if m.StartTime != nil {
		StartTime = timestamppb.New(*m.StartTime)
		if err := StartTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating start_time: %w", err)
		}
	}

	var ScheduleTime *timestamppb.Timestamp
	if m.ScheduleTime != nil {
		ScheduleTime = timestamppb.New(*m.ScheduleTime)
		if err := ScheduleTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating schedule_time: %w", err)
		}
	}

	var CompleteTime *timestamppb.Timestamp
	if m.CompleteTime != nil {
		CompleteTime = timestamppb.New(*m.CompleteTime)
		if err := CompleteTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating complete_time: %w", err)
		}
	}

	var LockTime *timestamppb.Timestamp
	if m.LockTime != nil {
		LockTime = timestamppb.New(*m.LockTime)
		if err := LockTime.CheckValid(); err != nil {
			return nil, fmt.Errorf("validating lock_time: %w", err)
		}
	}

	Payload := &anypb.Any{}
	if err := pbutil.Unmarshal(m.Payload, Payload); err != nil {
		return nil, fmt.Errorf("marshaling Payload: %w", err)
	}

	Metadata := map[string]string{}
	if err := json.Unmarshal(m.Metadata, &Metadata); err != nil {
		return nil, fmt.Errorf("marshaling Metadata: %w", err)
	}

	var FailureReason string
	if m.FailureReason != nil {
		FailureReason = *m.FailureReason
	}

	name := resourcename.Sprint("jobs/{job}", m.JobID)
	if err := resourcename.Validate(name); err != nil {
		return nil, fmt.Errorf("validating resource name: %w", err)
	}
	return &v1.Job{
		Name: name,

		CreateTime:    CreateTime,
		StartTime:     StartTime,
		ScheduleTime:  ScheduleTime,
		CompleteTime:  CompleteTime,
		LockTime:      LockTime,
		Payload:       Payload,
		Metadata:      Metadata,
		AttemptCount:  m.AttemptCount,
		FailureReason: FailureReason,
	}, nil
}

func ParseJobName(name string) (string, error) {
	var JobID string
	if err := resourcename.Sscan(name, "jobs/{job}", &JobID); err != nil {
		return "", fmt.Errorf("parsing resource name: %v", err)
	}
	return JobID, nil
}
