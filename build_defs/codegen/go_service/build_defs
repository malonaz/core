subinclude("//build_defs:template")
subinclude("//build_defs:docker")
subinclude("//build_defs:utils")

# Schema templates.
_SCHEMA_MAIN_GO = plugin_target("//build_defs/codegen/go_service/schemas:main.go.schema")
_SCHEMA_SERVICE_GO = plugin_target("//build_defs/codegen/go_service/schemas:service.go.schema")

# Codegen templates.
_TEMPLATE_UTILS_GO = plugin_target("//build_defs/codegen/go_service/templates:utils.go.tmpl")
_TEMPLATE_SERVICE_GO = plugin_target("//build_defs/codegen/go_service/templates:service.go.tmpl")
_TEMPLATE_MAIN_GO = [
    plugin_target("//build_defs/codegen/go_service/templates/main:main.go.tmpl"),
    plugin_target("//build_defs/codegen/go_service/templates/main:main.opts.go.tmpl"),
    plugin_target("//build_defs/codegen/go_service/templates/main:main.shutdown.go.tmpl"),
]

def go_main_manifest(
        name:str,
        manifest:str="manifest.yaml",
        deps:list=[],
        visibility:list=[],
        schema:str=_SCHEMA_MAIN_GO,
        ignore_schema:bool=False,
        test_only:bool=False,
):
    return go_manifest(
        name=name,
        manifest=manifest,
        deps=deps,
        visibility=visibility,
        schema=schema,
        ignore_schema=ignore_schema,
        test_only=test_only,
    )


def go_service_manifest(
        name:str,
        manifest:str="manifest.yaml",
        deps:list=[],
        visibility:list=[],
        schema:str=_SCHEMA_SERVICE_GO,
        ignore_schema:bool=False,
        test_only:bool=False,
):
    return go_manifest(
        name=name,
        manifest=manifest,
        deps=deps,
        visibility=visibility,
        schema=schema,
        ignore_schema=ignore_schema,
        test_only=test_only,
    )

def go_manifest(
        name:str,
        manifest:str="manifest.yaml",
        deps:list=[],
        visibility:list=[],
        schema:str=None,
        ignore_schema:bool=False,
        test_only:bool=False,
):
    if len(deps) == 0:
        # If no deps, just use the original manifest
        templated_manifest = text_template(
            name = "manifest_templated.yaml",
            src = manifest,
            test_only=test_only,
        )
    else:
        # Build awk commands using variables (safer than inline strings)
        awk_commands = ["cp $SRC $OUT"]
        for i, dep in enumerate(deps):
            canonical_dep = canonicalise(dep)
            replacement = f"{canonical_dep}($(locations {dep}))"

            # Use awk with -v to pass variables (avoids shell escaping issues)
            awk_commands.append(f'awk -v old="{dep}" -v new="{replacement}" \'{{ gsub(old, new); print }}\' $OUT > $OUT.tmp && mv $OUT.tmp $OUT')

        cmd = "\n".join(awk_commands)

        genrule(
            name = f"{name}_processed_manifest",
            srcs = [manifest],
            deps = deps,
            cmd = cmd,
            out = f"{name}_processed_manifest",
            test_only=test_only,
        )

        templated_manifest = text_template(
            name = f"{name}_manifest_templated.yaml",
            src = f":{name}_processed_manifest",
            test_only=test_only,
        )

    # Skip validation if ignore_schema is True
    if ignore_schema:
        return filegroup(
            name = name,
            srcs = [templated_manifest],
            exported_deps = deps,
            visibility = visibility,
            test_only=test_only,
        )
    else:
        return validated_file(
            name = name,
            src = templated_manifest,
            schema = schema,
            format = "yaml",
            exported_deps = deps,
            visibility = visibility,
            test_only=test_only,
        )

def go_service_src(
        name:str,
        manifest:str,
        templates:list=[],
        visibility:list=[],
        exclude_default_templates:bool=False,
        test_only:bool=False,
):
    if not exclude_default_templates:
        if len(templates) == 0:
            templates = [_TEMPLATE_SERVICE_GO]
        templates.append(_TEMPLATE_UTILS_GO)
    return go_template(
        name = name,
        templates = templates,
        data = manifest,
        format = "yaml",
        visibility = visibility,
        test_only=test_only,
    )

def go_main_src(
        name:str,
        manifest:str,
        templates:list=[],
        visibility:list=[],
        test_only:bool=False,
):
    if len(templates) == 0:
        templates = _TEMPLATE_MAIN_GO
    templates.append(_TEMPLATE_UTILS_GO)

    return go_template(
        name = name,
        templates = templates,
        data = manifest,
        format = "yaml",
        visibility = visibility,
        test_only=test_only,
    )

def go_src(
        name:str,
        manifest:str,
        templates:list,
        visibility:list=[],
        test_only:bool=False,
):
    templates.append(_TEMPLATE_UTILS_GO)

    return go_template(
        name = name,
        templates = templates,
        data = manifest,
        format = "yaml",
        visibility = visibility,
        test_only=test_only,
    )
