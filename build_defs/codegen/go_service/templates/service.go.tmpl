package {{ .implementation | base}}

var log = {{ goImport "github.com/malonaz/core/go/logging" }}.NewLogger()

{{ if .includeRuntime }}
type Opts struct{}

type Runtime struct{}

func newRuntime(opts *Opts) (*Runtime, error) {
    return &Runtime{}, nil
}

func (s *Service) start(ctx {{ goImport "context" }}.Context) (func(), error) { return func() {}, nil }
{{ end }}

type Service struct {
	*Runtime
	opts *Opts
        {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ grpcSvcName $dep.proto | untitle }}Client {{ plzGoImport $dep.proto (protoGoImportAlias $dep.proto)}}.{{ grpcSvcName $dep.proto }}Client
            {{- else if eq $dep.type "postgres" }}
                {{ $dep.name }}DBClient *{{ plzGoImport $dep.implementation }}.DB
            {{- end }}
        {{- end }}
}


// New instantiates and returns a new service.
func New(
	opts *Opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ grpcSvcName $dep.proto | untitle }}Client {{ plzGoImport $dep.proto (protoGoImportAlias $dep.proto)}}.{{ grpcSvcName $dep.proto }}Client,
            {{- else if eq $dep.type "postgres" }}
                {{ $dep.name }}DBClient *{{ plzGoImport $dep.implementation }}.DB,
            {{- end }}
        {{- end }}

) (*Service, error) {
	runtime, err := newRuntime(opts)
	if err != nil {
		return nil, {{ goImport "fmt" }}.Errorf("instantiating runtime: %w", err)
	}
	return &Service{
		Runtime: runtime,
		opts: opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ grpcSvcName $dep.proto | untitle }}Client: {{ grpcSvcName $dep.proto | untitle }}Client,
            {{- else if eq $dep.type "postgres" }}
                {{ $dep.name }}DBClient: {{ $dep.name }}DBClient,
            {{- end }}
        {{- end }}
	}, nil
}

// Start this service. Returns clean up function.
func (s *Service) Start(ctx {{ goImport "context" }}.Context) (func(), error) {
	return s.start(ctx)
}
