package {{ .implementation | base}}
{{- $exportFields := not (empty .exportServiceFields) }}

var log = {{ goImport "github.com/malonaz/core/go/logging" }}.NewLogger()


{{ if .includeRuntime }}
type Opts struct{}

type Runtime struct{}

func newRuntime(opts *Opts) (*Runtime, error) {
    return &Runtime{}, nil
}

func (s *Service) start(ctx {{ goImport "context" }}.Context) (func(), error) { return func() {}, nil }
{{ end }}

type Service struct {
	*Runtime
	{{ ternary "Opts" "opts" $exportFields }} *Opts
  {{ ternary "With" "with" $exportFields }}ServiceAccount func({{ goImport "context" }}.Context) {{ goImport "context" }}.Context
        {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name}}
                {{ ternary ($grpc.Client | title) $grpc.Client $exportFields }} {{ $grpc.ClientInterface }}
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}DBClient *{{ plzGoImport $dep.implementation }}.DB
            {{- else if eq $dep.type "postgres_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}PostgresClient *{{ goImport "github.com/malonaz/core/go/postgres" }}.Client
            {{- end }}
        {{- end }}
}


// New instantiates and returns a new service.
func New(
	opts *Opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name }}
                {{ $grpc.Client }} {{ $grpc.ClientInterface }},
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ $dep.name }}DBClient *{{ plzGoImport $dep.implementation }}.DB,
            {{- else if eq $dep.type "postgres_client" }}
                {{ $dep.name }}PostgresClient *{{ goImport "github.com/malonaz/core/go/postgres" }}.Client,
            {{- end }}
        {{- end }}

) (*Service, error) {
	runtime, err := newRuntime(opts)
	if err != nil {
		return nil, {{ goImport "fmt" }}.Errorf("instantiating runtime: %w", err)
	}
	return &Service{
		Runtime: runtime,
		{{ ternary "Opts" "opts" $exportFields }}: opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name }}
                {{ ternary ($grpc.Client | title) $grpc.Client $exportFields }}: {{ $grpc.Client }},
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}DBClient: {{ $dep.name }}DBClient,
            {{- else if eq $dep.type "postgres_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}PostgresClient: {{ $dep.name }}PostgresClient,
            {{- end }}
        {{- end }}
	}, nil
}

// Start this service. Returns clean up function.
func (s *Service) Start(ctx {{ goImport "context" }}.Context, withServiceAccount func({{ goImport "context" }}.Context) {{ goImport "context" }}.Context) (func(), error) {
  s.{{ ternary "With" "with" $exportFields }}ServiceAccount = withServiceAccount
  ctxSA := withServiceAccount(ctx)
	return s.start(ctxSA)
}
