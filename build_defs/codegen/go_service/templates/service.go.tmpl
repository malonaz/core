package {{ .implementation | base}}
{{- $exportFields := not (empty .exportServiceFields) }}

{{ if .includeRuntime }}
type Opts struct{}

type runtime struct{}

func newRuntime(opts *Opts) (*runtime, error) {
    return &runtime{}, nil
}

func (s *Service) start(ctx {{ goImport "context" }}.Context) (func(), error) { return func() {}, nil }
{{ end }}

type Service struct {
  *runtime
  *codegen
}

type codegen struct {
	log *{{ goImport "log/slog" }}.Logger
	{{ ternary "Opts" "opts" $exportFields }} *Opts
  {{ ternary "With" "with" $exportFields }}ServiceAccount func({{ goImport "context" }}.Context) {{ goImport "context" }}.Context
        {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name}}
                {{ ternary ($grpc.Client | title) $grpc.Client $exportFields }} {{ $grpc.ClientInterface }}
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}DBClient *{{ plzGoImport $dep.implementation }}.DB
            {{- else if eq $dep.type "postgres_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}PostgresClient *{{ goImport "github.com/malonaz/core/go/postgres" }}.Client
            {{- end }}
        {{- end }}
}

func (s *Service) WithLogger(logger *{{ goImport "log/slog" }}.Logger) *Service {
	s.log = logger
	return s
}

// New instantiates and returns a new service.
func New(
	opts *Opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name }}
                {{ $grpc.Client }} {{ $grpc.ClientInterface }},
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ $dep.name }}DBClient *{{ plzGoImport $dep.implementation }}.DB,
            {{- else if eq $dep.type "postgres_client" }}
                {{ $dep.name }}PostgresClient *{{ goImport "github.com/malonaz/core/go/postgres" }}.Client,
            {{- end }}
        {{- end }}

) (*Service, error) {
	runtime, err := newRuntime(opts)
	if err != nil {
		return nil, {{ goImport "fmt" }}.Errorf("instantiating runtime: %w", err)
	}
	codegen := &codegen{
		log: {{ goImport "log/slog" }}.Default(),
		{{ ternary "Opts" "opts" $exportFields }}: opts,
      {{- range $dep := .dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name }}
                {{ ternary ($grpc.Client | title) $grpc.Client $exportFields }}: {{ $grpc.Client }},
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}DBClient: {{ $dep.name }}DBClient,
            {{- else if eq $dep.type "postgres_client" }}
                {{ ternary ($dep.name | title) $dep.name $exportFields }}PostgresClient: {{ $dep.name }}PostgresClient,
            {{- end }}
        {{- end }}
	}
  return &Service{
   runtime: runtime,
   codegen: codegen,
  }, nil
}

// Start this service. Returns clean up function.
func (s *Service) Start(ctx {{ goImport "context" }}.Context, withServiceAccount func({{ goImport "context" }}.Context) {{ goImport "context" }}.Context) (func(), error) {
  s.{{ ternary "With" "with" $exportFields }}ServiceAccount = withServiceAccount
  ctxSA := withServiceAccount(ctx)
	return s.start(ctxSA)
}
