// Code generated by 'github.com/malonaz/core/tools/template'. DO NOT EDIT.
// This file is automatically generated from templates/main.go.tmpl
// To make changes, edit the template file and regenerate.
package main

var log = {{ goImport "github.com/malonaz/core/go/logging" }}.NewLogger()

var opts struct {
{{ template "mainOpts" . }}
}

func main() {
{{ goImport "math/rand" }}.Seed({{ goImport "time"}}.Now().UnixNano())
{{ goImport "github.com/malonaz/core/go/flags" }}.MustParse(&opts)
{{ goImport "github.com/malonaz/core/go/prometheus" }}.Serve(opts.Prometheus)
ctx := {{ goImport "context" }}.Background()

{{- /* GATHER SERVICE MANIFESTS */ -}}
{{- $serviceManifests := list -}}
{{- $serviceNameToServerNames := dict -}}
{{- range $server := .servers -}}
    {{- range $service := $server.services -}}
        {{- $serviceManifest := parseYaml $service.manifest -}}
        {{- $serviceManifests = append $serviceManifests $serviceManifest -}}
        {{- $existingServers := index $serviceNameToServerNames $serviceManifest.name | default (list) -}}
        {{- $updatedServers := append $existingServers $server.name -}}
        {{- $serviceNameToServerNames = set $serviceNameToServerNames $serviceManifest.name $updatedServers -}}

    {{- end -}}
{{- end -}}

{{- $serverNameToServiceNameToHealthCheckFunctions := dict -}}

{{- /* DEPENDENCIES GRPC CONNECTIONS*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}

        {{- if eq $dep.type "grpc_client" -}}
            {{- if doOnce "grpc_conns_instantiations" -}}
                {{ "\n\n// Instantiate GRPC Connections (using one per identical endpoint)\n" -}}
                endpointToGRPCConnection := map[string]*{{ goImport "github.com/malonaz/core/go/grpc" }}.Connection{}
            {{- end -}}

            {{- if doOnce (printf "grpc_conn_deps_%s" $dep.proto) -}}
                {{ $grpc := parseGRPC $dep.proto $dep.name }}
                if _, ok := endpointToGRPCConnection[opts.{{ $grpc.OptsFieldName }}.Endpoint()]; !ok {
                connection, err := {{ $grpc.NewConnection }}
                if err != nil {
                log.Panicf("instantiating new connection [%s]: %v", "{{ $dep.proto }}", err)
                }
                if err := connection.Connect(); err != nil {
                log.Panicf("connecting [%s]: %v", "{{ $dep.proto }}", err)
                }
                defer connection.Close()
                endpointToGRPCConnection[opts.{{ $grpc.OptsFieldName }}.Endpoint()] = connection
                }
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

{{- /* DEPENDENCIES GRPC CLIENTS*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}
        {{- if eq $dep.type "grpc_client" -}}
            {{ $grpc := parseGRPC $dep.proto $dep.name }}
            {{- if doOnce "grpc_client_instantiations" -}}{{ "\n\n// Instantiate GRPC Clients" -}}{{- end -}}
            {{- if doOnce (printf "grpc_deps_%s" $dep.proto) }}
                {{ $grpc.Connection }}, ok := endpointToGRPCConnection[opts.{{ $grpc.OptsFieldName }}.Endpoint()]
                if !ok {
                log.Panicf("could not find grpc connection on for {{ $grpc.HumanName}}")
                }
                {{ $grpc.Client }} := {{ $grpc.NewClient }}
                {{ $grpc.HealthCheck }} := {{ $grpc.Connection }}.HealthCheckFn({{ $grpc.ServiceDescriptionName }})
            {{ end }}

            {{- /* Add health check function to all servers that use this service */ -}}
            {{- $serverNames := index $serviceNameToServerNames $serviceManifest.name -}}
            {{- range $serverName := $serverNames -}}
                {{- $serverHealthChecks := index $serverNameToServiceNameToHealthCheckFunctions $serverName | default (dict) -}}
                {{- $existingHealthChecks := index $serverHealthChecks $serviceManifest.name | default (list) -}}
                {{- $updatedHealthChecks := append $existingHealthChecks $grpc.HealthCheck -}}
                {{- $serverHealthChecks = set $serverHealthChecks $serviceManifest.name $updatedHealthChecks -}}
                {{- $serverNameToServiceNameToHealthCheckFunctions = set $serverNameToServiceNameToHealthCheckFunctions $serverName $serverHealthChecks -}}
            {{- end -}}
        {{- end }}
    {{- end }}
{{- end }}


{{- /* DEPENDENCIES POSTGRES Connections*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}
        {{- if or (eq $dep.type "postgres_db_client") (eq $dep.type "postgres_client") -}}
            {{- if doOnce "postgres_db_client_instantiations" -}}
                {{ "\n\n// Instantiate Postgres Connections (using one per identical endpoint)" }}
                endpointToPostgresConnection := map[string]*{{ goImport "github.com/malonaz/core/go/postgres" }}.Client{}
            {{- end }}
            if _, ok := endpointToPostgresConnection[opts.{{ $dep.name | camelcase }}Postgres.Endpoint()]; !ok {
            connection := {{ goImport "github.com/malonaz/core/go/postgres" }}.MustNewClient(opts.{{ $dep.name | camelcase }}Postgres)
	          defer connection.Close()
            endpointToPostgresConnection[opts.{{ $dep.name | camelcase }}Postgres.Endpoint()] = connection
            }
        {{- end }}
    {{- end }}
{{- end }}

{{- /* DEPENDENCIES POSTGRES*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}
        {{- if or (eq $dep.type "postgres_db_client") (eq $dep.type "postgres_client") -}}
            {{- $dbKey := printf "postgres_db_client_%s_%s" $dep.name  -}}
            {{- if doOnce $dbKey }}
                {{- "\n" }}
                // Instantiate {{ $dep.name }} db client.
	              {{ $dep.name | camelcase | untitle }}PsqlClient, ok := endpointToPostgresConnection[opts.{{ $dep.name | camelcase }}Postgres.Endpoint()]
                if !ok {
                log.Panicf("could not find postgres connection for {{ $dep.name }}")
                }
            {{- end }}

            {{- /* Add health check function to all servers that use this service */ -}}
            {{- $serverNames := index $serviceNameToServerNames $serviceManifest.name -}}
            {{- range $serverName := $serverNames -}}
                {{- $serverHealthChecks := index $serverNameToServiceNameToHealthCheckFunctions $serverName | default (dict) -}}
                {{- $existingHealthChecks := index $serverHealthChecks $serviceManifest.name | default (list) -}}
                {{- $updatedHealthChecks := append $existingHealthChecks (printf "%sPsqlClient.Ping" ($dep.name | camelcase | untitle)) -}}
                {{- $serverHealthChecks = set $serverHealthChecks $serviceManifest.name $updatedHealthChecks -}}
                {{- $serverNameToServiceNameToHealthCheckFunctions = set $serverNameToServiceNameToHealthCheckFunctions $serverName $serverHealthChecks -}}
            {{- end -}}

            {{- if eq $dep.type "postgres_db_client" -}}
                {{- $dbImplKey := printf "postgres_impl_%s_%s" $dep.name $dep.implementation  -}}
                {{- if doOnce $dbImplKey }}
                    {{ $dep.name | camelcase | untitle }}_{{ $dep.implementation | replace "/" "_" | replace "." "_" }}DBClient := {{ plzGoImport $dep.implementation }}.New({{ $dep.name | camelcase | untitle }}PsqlClient)
                {{ end }}
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

healthServer := {{ goImport "github.com/malonaz/core/go/health" }}.NewServer(opts.Health)
var gracefulStopFns []func() error
var stopFns []func() error

{{ range $server := .servers }}

    // Start {{ $server.name | camelcase }} Server
    {
    withServiceAccount := func(ctx context.Context) (context.Context, error) {
    ctxSA, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.WithServiceAccount(ctx, "{{ $server.name | kebabcase }}")
    if err != nil {
    return nil, err
    }
    ctxSA = {{ goImport "github.com/malonaz/core/go/contexttag" }}.SetOntoContextNoop(ctxSA)
    return ctxSA, nil
    }

    {{- /* INSTANTIATE SERVICES*/ -}}
    {{- range $service := $server.services }}
        {{- $serviceManifest := parseYaml $service.manifest -}}
        {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
        {{ if not (doOnce (printf "%s/%s" $server.name $serviceName)) }}{{ continue }}{{ end }}

        {{ "\n" }}// Instantiate {{ $serviceName }}.
        {{ $serviceName }}, err := {{ plzGoImport $serviceManifest.implementation }}.New(
        opts.{{ $serviceName | title }},
        {{- range $dep := $serviceManifest.dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto $dep.name -}}
                {{ $grpc.Client }},
            {{- else if eq $dep.type "postgres_db_client" }}
                {{ $dep.name | camelcase | untitle }}_{{ $dep.implementation | replace "/" "_" | replace "." "_"  }}DBClient,
            {{- else if eq $dep.type "postgres_client" }}
                {{ $dep.name | camelcase | untitle }}PsqlClient,
            {{- end }}
        {{- end }}
        )
        if err != nil {
        log.Panicf("instantiating {{ $serviceName }}: %v", err)
        }
        // Start {{ $serviceName }} service.
        {{ $serviceName }}Cleanup, err := {{ $serviceName }}.Start(ctx, withServiceAccount)
        if err != nil {
        log.Panicf("starting {{ $serviceName }} service: %v", err)
        }
        defer {{ $serviceName }}Cleanup()
    {{- end }}

    {{- if eq $server.type "grpc" }}
        register := func(server *{{ goImport "github.com/malonaz/core/go/grpc"}}.Server) {
        {{- range $service := $server.services }}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
            {{ $grpc := parseGRPC $service.proto "" -}}
            {{ $grpc.Register $serviceName }}
        {{- end }}
        }

        {{- range $interceptor := $server.interceptors -}}
            {{ if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor := {{ goImport "github.com/malonaz/core/go/authentication" }}.NewSessionInjectorInterceptor()
            {{ else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.New{{ $interceptor.type | camelcase }}Interceptor(opts.{{ $interceptor.type | camelcase }})
                if err != nil {
                log.Panicf("instantiating {{ $interceptor.type | replace "_" " " }} interceptor: %v", err)
                }
            {{ else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.New{{ $interceptor.type | camelcase }}Interceptor(opts.{{ $interceptor.type | camelcase }})
                if err != nil {
                log.Panicf("instantiating {{ $interceptor.type | replace "_" " " }} interceptor: %v", err)
                }
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{ end }}
        {{- end }}

	      grpcServer, err := {{ goImport "github.com/malonaz/core/go/grpc"}}.NewServer(opts.{{ $server.name | camelcase }}GRPC, opts.Certs, opts.Prometheus, register)
        if err != nil {
        log.Panicf("instantiating grpc server [%s]: %v", "{{ $server.name }}", err)
        }

        grpcServer.WithUnaryInterceptors({{- range $interceptor := $server.interceptors -}}
            {{- if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor.Unary(),
            {{- else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Unary(),
            {{- else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Unary(),
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{- end -}}
        {{- end -}}).
        WithStreamInterceptors({{- range $interceptor := $server.interceptors -}}
            {{- if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor.Stream(),
            {{- else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Stream(),
            {{- else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Stream(),
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{- end -}}
        {{- end -}})
        gracefulStopFns = append(gracefulStopFns, grpcServer.GracefulStop)
        stopFns = append(stopFns, grpcServer.Stop)
        {{- range $service := $server.services }}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
            {{ $grpc := parseGRPC $service.proto "" -}}
            {{- $serverHealthChecks := index $serverNameToServiceNameToHealthCheckFunctions $server.name -}}
            {{- $serviceHealthChecks := index $serverHealthChecks $serviceManifest.name | default (list) -}}
            grpcServer.GetHealthServer().RegisterService(
            {{- $grpc.ServiceDescriptionName -}},
            {{- range $healthCheckFn := $serviceHealthChecks -}}
                {{ $healthCheckFn }},
            {{- end -}}
            )
        {{- end }}
        healthServer.RegisterService("{{ $server.name }}", grpcServer.GetHealthServer().CheckFn())
        serveOrPanic(ctx, "{{ $server.name }}", grpcServer.Serve)

        {{- $hasGateway := false -}}
        {{- range $service := $server.services -}}
            {{- if $service.gateway -}}
                {{- $grpc := parseGRPC $service.proto "" -}}
                {{- if doOnce $server.name }}
                    {{ $hasGateway = true }}
                    // GRPC gateway handlers.
                    var registerHandlers =[]{{ goImport "github.com/malonaz/core/go/grpc" }}.RegisterHandler{
                {{- end }}
                {{ $grpc.RegisterHandlerFromEndpoint }},
            {{ end }}
        {{ end }}
        {{- if $hasGateway -}}
            }
            grpcGatewayServer, err := grpc.NewGateway(opts.{{ $server.name | camelcase }}GRPCGateway, opts.{{ $server.name | camelcase }}GRPC, opts.Certs, opts.Prometheus, registerHandlers)
            if err != nil {
            log.Panicf("instantiating grpc gateway [%s]: %v", "{{ $server.name }}", err)
            }
            serveOrPanic(ctx, "{{ $server.name }}", grpcGatewayServer.Serve)
        {{- end }}
    {{- end }}

    {{- if eq $server.type "http" }}
        register := func(server *{{ goImport "github.com/malonaz/core/go/http"}}.Server) {
        {{- range $service := $server.services }}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
            {{ $serviceName }}.RegisterRoutes(server)
        {{- end }}
        }

	      httpServer := {{ goImport "github.com/malonaz/core/go/http"}}.NewServer(opts.{{ $server.name | camelcase }}HTTP, register)
        gracefulStopFns = append(gracefulStopFns, httpServer.GracefulStop)
        stopFns = append(stopFns, httpServer.Stop)
        {{- range $service := $server.services }}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
            {{- $serverHealthChecks := index $serverNameToServiceNameToHealthCheckFunctions $server.name | default (dict) -}}
            {{- $serviceHealthChecks := index $serverHealthChecks $serviceManifest.name | default (list) }}
            httpServer.GetHealthServer().RegisterService(
            "{{- $serviceName | kebabcase}}",
            {{- range $healthCheckFn := $serviceHealthChecks -}}
                {{ $healthCheckFn }},
            {{- end -}}
            )
        {{- end }}
        healthServer.RegisterService("{{ $server.name }}", httpServer.GetHealthServer().CheckFn())
        serveOrPanic(ctx, "{{ $server.name }}", httpServer.Serve)
    {{- end }}
    }
{{- end }}


// Setup health check.
go healthServer.Serve(ctx)

gracefulStopFns = append(gracefulStopFns, func() error {
healthServer.Shutdown()
return nil
})
healthServer.MarkReady()
  handleSignals(gracefulStopFns, stopFns)
}

{{ template "shutdownOpts" . }}

func serveOrPanic(ctx context.Context, serverName string, serveFn func(context.Context) error) {
    go func() {
        if err := serveFn(ctx); err != nil {
            log.Panicf("server [%s] failed: %v", serverName, err)
        }
    }()
}
