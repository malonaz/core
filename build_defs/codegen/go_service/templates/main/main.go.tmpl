package main

var log = {{ goImport "github.com/malonaz/core/go/logging" }}.NewLogger()

var opts struct {
{{ template "mainOpts" . }}
}

func main() {
{{ goImport "math/rand" }}.Seed({{ goImport "time"}}.Now().UnixNano())
{{ goImport "github.com/malonaz/core/go/flags" }}.MustParse(&opts)
{{ goImport "github.com/malonaz/core/go/prometheus" }}.Serve(opts.Prometheus)
ctx := {{ goImport "context" }}.Background()

var healthChecks []{{ goImport "github.com/malonaz/core/go/health" }}.Check

{{- /* GATHER SERVICE MANIFESTS */ -}}
{{- $serviceManifests := list -}}
{{- range $server := .servers -}}
    {{- if eq $server.type "grpc" -}}
        {{- range $service := $server.services -}}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceManifests = append $serviceManifests $serviceManifest -}}
        {{- end -}}
    {{- end -}}
{{- end -}}


{{- /* DEPENDENCIES GRPC*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}
        {{- if eq $dep.type "grpc_client" -}}
            {{- if doOnce "grpc_client_instantiations" -}}{{ "\n\n// Instantiate GRPC Clients\n" -}}{{- end -}}
            {{- if doOnce (printf "grpc_deps_%s" $dep.proto) -}}
                {{ $grpc := parseGRPC $dep.proto }}
                {{ $grpc.Connection }}, {{ $grpc.HealthCheck }} := {{ $grpc.NewConnection }}.Connect()
                defer {{ $grpc.Connection }}.Close()
                {{ $grpc.Client }} := {{ $grpc.NewClient }}
                healthChecks = append(healthChecks, {{ $grpc.HealthCheck }})
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

{{- /* DEPENDENCIES POSTGRES*/ -}}
{{- range $serviceManifest := $serviceManifests -}}
    {{- range $dep := $serviceManifest.dependencies -}}
        {{- if eq $dep.type "postgres" -}}
            {{- $dbKey := printf "postgres_db_%s" $dep.name -}}
            {{- if doOnce $dbKey }}
                {{- "\n" }}
                // Instantiate {{ $dep.name }} db client.
	              {{ $dep.name }}PsqlClient := {{ goImport "github.com/malonaz/core/go/postgres" }}.MustNewClient(opts.{{ $dep.name | title }}Postgres)
	              defer {{ $dep.name }}PsqlClient.Close()
                {{ $dep.name }}DBClient := {{ plzGoImport $dep.implementation }}.New({{ $dep.name }}PsqlClient)
                healthChecks = append(healthChecks, {{ $dep.name }}PsqlClient.Ping)
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }}

// Setup health check.
healthCheck := {{ goImport "github.com/malonaz/core/go/health" }}.Checks(healthChecks...)
healthServer := {{ goImport "github.com/malonaz/core/go/health" }}.NewServer(opts.Health, healthCheck)
go healthServer.Serve(ctx)

var gracefulStopFns []func()
var stopFns []func()

{{ range $server := .servers }}
    // Start {{ $server.name | camelcase }} Server
    {
    ctxSA, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.WithServiceAccount(ctx, "{{ .serviceAccount }}")
    if err != nil {
    log.Panicf("injecting role into context: %v", err)
    }
    ctxSA = {{ goImport "github.com/malonaz/core/go/contexttag" }}.SetOntoContextNoop(ctxSA)

    {{- /* INSTANTIATE SERVICES*/ -}}
    {{- range $service := $server.services }}
        {{- $serviceManifest := parseYaml $service.manifest -}}
        {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
        {{- $serviceKey := printf "service_%s" $serviceManifest.implementation }}
        {{ "\n" }}// Instantiate {{ $serviceName }}.
        {{ $serviceName }}, err := {{ plzGoImport $serviceManifest.implementation }}.New(
        opts.{{ $serviceName | title }},
        {{- range $dep := $serviceManifest.dependencies }}
            {{- if eq $dep.type "grpc_client" }}
                {{ $grpc := parseGRPC $dep.proto -}}
                {{ $grpc.Client }},
            {{- else if eq $dep.type "postgres" }}
                {{ $dep.name }}DBClient,
            {{- end }}
        {{- end }}
        )
        if err != nil {
        log.Panicf("instantiating {{ $serviceName }}: %v", err)
        }
        // Start {{ $serviceName }} service.
        {{ $serviceName }}Cleanup, err := {{ $serviceName }}.Start(ctxSA)
        if err != nil {
        log.Panicf("starting {{ $serviceName }} service: %v", err)
        }
        defer {{ $serviceName }}Cleanup()
    {{- end }}

    {{- if eq $server.type "grpc" }}
        register := func(server *{{ goImport "github.com/malonaz/core/go/grpc"}}.Server) {
        {{- range $service := $server.services }}
            {{- $serviceManifest := parseYaml $service.manifest -}}
            {{- $serviceName := $serviceManifest.name | camelcase | untitle}}
            {{ $grpc := parseGRPC $service.proto -}}
            {{ $grpc.Register $serviceName }}
        {{- end }}
        }

        {{- range $interceptor := $server.interceptors -}}
            {{ if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor := {{ goImport "github.com/malonaz/core/go/authentication" }}.NewSessionInjectorInterceptor()
            {{ else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.New{{ $interceptor.type | camelcase }}Interceptor(opts.{{ $interceptor.type | camelcase }})
                if err != nil {
                log.Panicf("instantiating {{ $interceptor.type | replace "_" " " }} interceptor: %v", err)
                }
            {{ else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor, err := {{ goImport "github.com/malonaz/core/go/authentication" }}.New{{ $interceptor.type | camelcase }}Interceptor(opts.{{ $interceptor.type | camelcase }})
                if err != nil {
                log.Panicf("instantiating {{ $interceptor.type | replace "_" " " }} interceptor: %v", err)
                }
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{ end }}
        {{- end }}

	      grpcServer := {{ goImport "github.com/malonaz/core/go/grpc"}}.NewServer(opts.{{ $server.name | camelcase }}GRPC, opts.Certs, opts.Prometheus, register).WithHealthCheck(healthCheck).
        WithUnaryInterceptors({{- range $interceptor := $server.interceptors -}}
            {{- if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor.Unary(),
            {{- else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Unary(),
            {{- else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Unary(),
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{- end -}}
        {{- end -}}).
        WithStreamInterceptors({{- range $interceptor := $server.interceptors -}}
            {{- if eq $interceptor.type "session_injector" }}
                sessionInjectorInterceptor.Stream(),
            {{- else if eq $interceptor.type "internal_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Stream(),
            {{- else if eq $interceptor.type "external_api_key_authentication" }}
                {{ $interceptor.type | camelcase | untitle }}Interceptor.Stream(),
            {{ else }}
                {{ fail (printf "Unknown interceptor type: %s" $interceptor.type) }}
            {{- end -}}
        {{- end -}})
        gracefulStopFns = append(gracefulStopFns, grpcServer.GracefulStop)
        stopFns = append(stopFns, grpcServer.Stop)
        go grpcServer.Serve()

        {{- $hasGateway := false -}}
        {{- range $service := $server.services -}}
            {{- if $service.gateway -}}
                {{- $grpc := parseGRPC $service.proto -}}
                {{- if doOnce $server.name }}
                    {{ $hasGateway = true }}
                    // GRPC gateway handlers.
                    var registerHandlers =[]{{ goImport "github.com/malonaz/core/go/grpc" }}.RegisterHandler{
                {{- end }}
                {{ $grpc.RegisterHandlerFromEndpoint }},
            {{ end }}
        {{ end }}
        {{- if $hasGateway -}}
            }
            grpcGatewayServer := grpc.NewGateway(opts.{{ $server.name | camelcase }}GRPCGateway, opts.{{ $server.name | camelcase }}GRPC, opts.Certs, opts.Prometheus, registerHandlers)
            go grpcGatewayServer.Serve(ctx)
        {{- end }}
    {{- end }}
    }
{{- end }}

  healthServer.MarkReady()
  handleSignals(gracefulStopFns, stopFns)
}

{{ template "shutdownOpts" . }}
