{{- define "shutdownOpts" -}}
    func handleSignals(gracefulStopFns, stopFns[]func() error) {
	  signalChan := make(chan {{ goImport "os" }}.Signal, 2) // One for each category of stops.
    {{ goImport "os/signal" }}.Notify(
  	signalChan,
  	{{ goImport "syscall" }}.SIGTERM,
  	{{ goImport "syscall" }}.SIGINT,
  	{{ goImport "syscall" }}.SIGHUP,
    )

	  // Wait for first signal
	  sig := <- signalChan
	  log.Infof("Received signal #1: %v, initiating graceful shutdown", sig)

	  // Set up a channel to know when graceful shutdown is complete
	  gracefulDone := make(chan struct{})

	  // Start graceful shutdown sequentially in reverse order in a goroutine
	  go func() {
		for i := len(gracefulStopFns) - 1; i >= 0; i-- {
		gracefulStopFns[i]()
		}
		close(gracefulDone)
	  }()

	  // Wait for either graceful shutdown to complete or second signal
	  select {
	  case <-gracefulDone:
		log.Info("Graceful shutdown completed")
	  case sig := <-signalChan:
		log.Warnf("Received signal #2: %v, forcing immediate shutdown", sig)
		// Force stop everything immediately sequentially in reverse order
		for i := len(stopFns) - 1; i >= 0; i-- {
		stopFns[i]()
		}
		log.Info("Force shutdown completed")
	  }
    }
{{- end -}}
