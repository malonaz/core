{{- /* ################### TOPLINE VARIABLES ################### */ -}}
{{ $file := .File }}
{{ $generatedFile := .GeneratedFile }}
{{- $goImportPath := $file.GoImportPath | toString | replace "\"" "" }}
{{- if $file.Desc.Options.GetGoPackage -}}{{- $goImportPath = printf "%s/llm" $file.Desc.Options.GetGoPackage }}{{- end -}}
{{ $apiImportPath := $goImportPath | dir }}
{{- $dummy := replaceImportPath $file.GoImportPath $apiImportPath -}}

{{- /* ################### HELPERS ################### */ -}}

{{- /* Helper to get all field names from a message */ -}}
{{- define "GetAllFieldNames" -}}
    {{- $fieldNames := list -}}
    {{- range $field := .Fields -}}
        {{- $fieldNames = append $fieldNames ($field.Desc.Name | toString) -}}
    {{- end -}}
    {{- $fieldNames | toJson -}}
{{- end -}}

{{- /* Helper to validate fields exist in a message */ -}}
{{- define "ValidateFields" -}}
    {{- $message := .message -}}
    {{- $documentFields := .documentFields -}}
    {{- $validFieldNames := list -}}
    {{- range $field := $message.Fields -}}
        {{- $validFieldNames = append $validFieldNames ($field.Desc.Name | toString) -}}
    {{- end -}}
    {{- range $specifiedField := $documentFields -}}
        {{- if not (has $specifiedField $validFieldNames) -}}
            {{ fail (printf "Invalid field '%s' specified in document.fields for message '%s'. Valid fields are: %v" $specifiedField $message.Desc.Name $validFieldNames) }}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- define "FieldTypeDoc" -}}
    {{- if .Enum -}}
        string (one of:
        {{- range $i, $value := .Enum.Values -}}
            {{- if $i -}}
                {{ " " }}("{{- $value.Desc.Name }}" {{ $value.Comments.Leading.String | trim }}),
            {{- end -}}
        {{- end -}})

    {{- else if .Message -}}
        {{- if eq .Message.Desc.FullName "google.protobuf.Timestamp" -}}
            string (ISO 8601 timestamp)
        {{- else -}}
            object
        {{- end -}}
    {{- else -}}
        {{- if eq .Desc.Kind.String "string" -}}
            string
        {{- else if or (eq .Desc.Kind.String "int32") (eq .Desc.Kind.String "int64") (eq .Desc.Kind.String "uint32") (eq .Desc.Kind.String "uint64") -}}
            number
        {{- else if or (eq .Desc.Kind.String "float") (eq .Desc.Kind.String "double") -}}
            number (float)
        {{- else if eq .Desc.Kind.String "bool" -}}
            boolean
        {{- else if eq .Desc.Kind.String "bytes" -}}
            string (base64)
        {{- else -}}
            {{ .Desc.Kind.String }}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- define "PostalAddressDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "region_code": string,  // Country/region code (e.g., "US", "CH")
    {{- $indent }}  "postal_code": string,  // Postal/ZIP code
    {{- $indent }}  "administrative_area": string,  // State/province/region
    {{- $indent }}  "locality": string,  // City/town
    {{- $indent }}  "address_lines": [string],  // Street address lines (in envelope order for the country)
    {{- $indent }}}
{{- end -}}

{{- define "DateDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "year": number,  // Year of the date. Must be from 1 to 9999.
    {{- $indent }}  "month": number // Month of a year. Must be from 1 to 12.
    {{- $indent }}  "day": number,  // Day of a month. Must be from 1 to 31 and valid for the year and month.
    {{- $indent }}}
{{- end -}}


{{- define "TimeOfDayDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "hours": number,  // Hours of day in 24 hour format. Should be from 0 to 23
    {{- $indent }}  "minutes": number // Minutes of hour of day. Must be from 0 to 59.,
    {{- $indent }}}
{{- end -}}

{{- define "FieldDoc" -}}
    {{- $indent := .indent -}}
    {{- $field := .field -}}
    {{- $documentAll := .documentAll -}}
    {{- $documentFields := .documentFields -}}
    {{- $fieldName := $field.Desc.Name | toString -}}
    {{- $shouldDoc := or $documentAll (has $fieldName $documentFields) -}}
    {{- if $shouldDoc -}}
        {{ $indent }}"{{ $field.Desc.Name -}}":
        {{- if $field.Desc.IsList -}}
            [
            {{- if $field.Message -}}
                {{- $nestedIndent := printf "%s  " $indent -}}
                {{- $nestedOpts := (getExt $field.Message.Desc "malonaz.codegen.llm.v1.document") -}}
                {{- $nestedAll := $nestedOpts.All -}}
                {{- $nestedFields := $nestedOpts.Fields -}}
                {{- if not $nestedFields }}{{ $nestedFields = list }}{{ end -}}
                {{- /* Validate nested message fields */ -}}
                {{- if and (not $nestedAll) $nestedFields -}}
                    {{- template "ValidateFields" dict "message" $field.Message "documentFields" $nestedFields -}}
                {{- end -}}
                {{ $nestedIndent }}{
                {{- template "MessageFieldsDoc" dict "message" $field.Message "indent" (printf "%s    " $indent) "documentAll" $nestedAll "documentFields" $nestedFields -}}
                {{ $nestedIndent }}}
            {{- else -}}
                {{ template "FieldTypeDoc" $field }}
            {{- end -}}
            ]
        {{- else if $field.Desc.IsMap -}}
            {
            {{ $indent }}  "key": {{ template "FieldTypeDoc" $field.Desc.MapKey }},
            {{ $indent }}  "value":
            {{- if $field.Desc.MapValue.Message -}}
                {
                {{- $nestedOpts := (getExt $field.Desc.MapValue.Message "malonaz.codegen.llm.v1.document") -}}
                {{- $nestedAll := $nestedOpts.All -}}
                {{- $nestedFields := $nestedOpts.Fields -}}
                {{- if not $nestedFields }}{{ $nestedFields = list }}{{ end -}}
                {{- template "MessageFieldsDoc" dict "message" $field.Desc.MapValue.Message "indent" (printf "%s    " $indent) "documentAll" $nestedAll "documentFields" $nestedFields -}}
                {{ $indent }}  }
            {{- else -}}
                {{ template "FieldTypeDoc" $field.Desc.MapValue }}
            {{- end -}}
            {{ $indent }}}
        {{- else if $field.Message -}}
            {{- if eq $field.Message.Desc.FullName "google.protobuf.Timestamp" -}}
                {{ template "FieldTypeDoc" $field }}
            {{- else if eq $field.Message.Desc.FullName "google.type.PostalAddress" -}}
                {{- template "PostalAddressDoc" dict "indent" (printf "%s    " $indent) -}}
            {{- else if eq $field.Message.Desc.FullName "google.type.Date" -}}
                {{- template "DateDoc" dict "indent" (printf "%s    " $indent) -}}
            {{- else if eq $field.Message.Desc.FullName "google.type.TimeOfDay" -}}
                {{- template "TimeOfDayDoc" dict "indent" (printf "%s    " $indent) -}}
            {{- else -}}
                {{- $nestedOpts := (getExt $field.Message.Desc "malonaz.codegen.llm.v1.document") -}}
                {{- $nestedAll := $nestedOpts.All -}}
                {{- $nestedFields := $nestedOpts.Fields -}}
                {{- if not $nestedFields }}{{ $nestedFields = list }}{{ end -}}
                {{- /* Validate nested message fields */ -}}
                {{- if and (not $nestedAll) $nestedFields -}}
                    {{- template "ValidateFields" dict "message" $field.Message "documentFields" $nestedFields -}}
                {{- end -}}
                {
                {{- template "MessageFieldsDoc" dict "message" $field.Message "indent" (printf "%s  " $indent) "documentAll" $nestedAll "documentFields" $nestedFields -}}
                {{ $indent }}}
            {{- end -}}
        {{- else -}}
            {{- template "FieldTypeDoc" $field -}}
        {{- end -}}
        {{- if $field.Comments.Leading -}}
            {{ " " }}{{ $field.Comments.Leading.String | trim }}
        {{- end -}}
    {{- end -}}
{{- end -}}


{{- define "MessageFieldsDoc" -}}
    {{- $message := .message -}}
    {{- $indent := .indent -}}
    {{- $documentAll := .documentAll -}}
    {{- $documentFields := .documentFields -}}
    {{- $processedOneofs := dict -}}
    {{- $firstField := true -}}
    {{- range $i, $field := $message.Fields -}}
        {{- $fieldName := $field.Desc.Name | toString -}}
        {{- $shouldDoc := or $documentAll (has $fieldName $documentFields) -}}
        {{- if $shouldDoc -}}
            {{- if $field.Oneof -}}
                {{- $oneofName := $field.Oneof.Desc.Name | toString -}}
                {{- if not (index $processedOneofs $oneofName) -}}
                    {{- $_ := set $processedOneofs $oneofName true -}}
                    {{- /* Check if any oneof field is documented */ -}}
                    {{- $hasVisibleOneofField := false -}}
                    {{- range $oneofField := $field.Oneof.Fields -}}
                        {{- $oneofFieldName := $oneofField.Desc.Name | toString -}}
                        {{- $oneofShouldDoc := or $documentAll (has $oneofFieldName $documentFields) -}}
                        {{- if $oneofShouldDoc -}}
                            {{- $hasVisibleOneofField = true -}}
                        {{- end -}}
                    {{- end -}}
                    {{- if $hasVisibleOneofField -}}
                        {{- if not $firstField -}},{{ end -}}
                        {{- $firstField = false }}
                        {{- $indent }}// ONEOF: exactly one of the following must be set: [
                        {{- $firstOneof := true -}}
                        {{- range $j, $oneofField := $field.Oneof.Fields -}}
                            {{- $oneofFieldName := $oneofField.Desc.Name | toString -}}
                            {{- $oneofShouldDoc := or $documentAll (has $oneofFieldName $documentFields) -}}
                            {{- if $oneofShouldDoc -}}
                                {{- if not $firstOneof -}}, {{ end -}}{{ $oneofField.Desc.Name }}
                                {{- $firstOneof = false -}}
                            {{- end -}}
                        {{- end -}}]
                        {{- $firstOneofField := true -}}
                        {{- range $j, $oneofField := $field.Oneof.Fields -}}
                            {{- $oneofFieldName := $oneofField.Desc.Name | toString -}}
                            {{- $oneofShouldDoc := or $documentAll (has $oneofFieldName $documentFields) -}}
                            {{- if $oneofShouldDoc -}}
                                {{- if not $firstOneofField -}},{{ end -}}
                                {{- $firstOneofField = false -}}
                                {{ template "FieldDoc" dict "field" $oneofField "indent" $indent "documentAll" $documentAll "documentFields" $documentFields -}}
                            {{- end -}}
                        {{- end }}
                    {{- end -}}
                {{- end -}}
            {{- else -}}
                {{- if not $firstField -}},{{ end -}}
                {{- $firstField = false -}}
                {{- template "FieldDoc" dict "field" $field "indent" $indent "documentAll" $documentAll "documentFields" $documentFields -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

// Code generated by protoc-templates. DO NOT EDIT.
// source: {{ $file.Desc.Path }}
package {{ if .PackageName }}{{ .PackageName }}{{ else }}{{ $goImportPath | base }}{{ end }}

{{- range $message := $file.Messages -}}
    {{- $documentOpts := (getExt .Desc "malonaz.codegen.llm.v1.document") -}}
    {{- $shouldGenerate := $documentOpts.Generate -}}
    {{- $documentAll := $documentOpts.All -}}
    {{- $documentFields := $documentOpts.Fields -}}
    {{- if not $documentFields }}{{ $documentFields = list }}{{ end -}}

    {{- /* Skip if generate is not true */ -}}
    {{- if not $shouldGenerate -}}{{ continue }}{{- end -}}

    {{- /* Validate that all specified fields exist */ -}}
    {{- if and (not $documentAll) (gt (len $documentFields) 0) -}}
        {{- template "ValidateFields" dict "message" $message "documentFields" $documentFields -}}
    {{- end }}

    func (m *{{ $message.GoIdent.GoName }}) Doc() string {
    return `Structure for {{ $message.Desc.Name }}: {{ if $message.Comments.Leading }}{{ $message.Comments.Leading.String | trim }}{{ end }}
{
{{- template "MessageFieldsDoc" dict "message" $message "indent" "\n  " "documentAll" $documentAll "documentFields" $documentFields }}
    }`
    }
{{ end -}}
