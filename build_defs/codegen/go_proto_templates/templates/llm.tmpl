{{- /* ################### TOPLINE VARIABLES ################### */ -}}
{{ $file := .File }}
{{ $generatedFile := .GeneratedFile }}
{{- $goImportPath := $file.GoImportPath | toString | replace "\"" "" }}
{{- if $file.Desc.Options.GetGoPackage -}}{{- $goImportPath = printf "%s/llm" $file.Desc.Options.GetGoPackage }}{{- end -}}
{{ $apiImportPath := $goImportPath | dir }}
{{- $dummy := replaceImportPath $file.GoImportPath $apiImportPath -}}

{{- /* ################### HELPERS ################### */ -}}

{{-  define "LeadingComment" -}}
    {{-  if . -}}
        {{ " // " }}{{ .String | replace "\n" "." | replace "//" "" | replace ".." "." | trim -}}
    {{- end -}}
{{- end -}}

{{- define "FieldTypeDoc" -}}
    {{- if .Enum -}}
        string (one of:
        {{- range $i, $value := .Enum.Values -}}
            {{- if $i -}}
                {{ " " }}("{{- $value.Desc.Name }}"{{ template "LeadingComment" $value.Comments.Leading }}),
            {{- end -}}
        {{- end -}})
    {{- else if .Message -}}
        {{- if eq .Message.Desc.FullName "google.protobuf.Timestamp" -}}
            string (ISO 8601 timestamp)
        {{- else -}}
            object
        {{- end -}}
    {{- else -}}
        {{- if eq .Desc.Kind.String "string" -}}
            string
        {{- else if or (eq .Desc.Kind.String "int32") (eq .Desc.Kind.String "int64") (eq .Desc.Kind.String "uint32") (eq .Desc.Kind.String "uint64") -}}
            number
        {{- else if or (eq .Desc.Kind.String "float") (eq .Desc.Kind.String "double") -}}
            number (float)
        {{- else if eq .Desc.Kind.String "bool" -}}
            boolean
        {{- else if eq .Desc.Kind.String "bytes" -}}
            string (base64)
        {{- else -}}
            {{ .Desc.Kind.String }}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- define "PostalAddressDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "region_code": string,  // Country/region code (e.g., "US", "CH")
    {{- $indent }}  "postal_code": string,  // Postal/ZIP code
    {{- $indent }}  "administrative_area": string,  // State/province/region
    {{- $indent }}  "locality": string,  // City/town
    {{- $indent }}  "address_lines": [string],  // Street address lines (in envelope order for the country)
    {{- $indent }}}
{{- end -}}

{{- define "DateDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "year": number,  // Year of the date. Must be from 1 to 9999.
    {{- $indent }}  "month": number // Month of a year. Must be from 1 to 12.
    {{- $indent }}  "day": number,  // Day of a month. Must be from 1 to 31 and valid for the year and month.
    {{- $indent }}}
{{- end -}}

{{- define "TimeOfDayDoc" -}}
    {{- $indent := .indent -}}
    {
    {{- $indent }}  "hours": number,  // Hours of day in 24 hour format. Should be from 0 to 23
    {{- $indent }}  "minutes": number // Minutes of hour of day. Must be from 0 to 59.,
    {{- $indent }}}
{{- end -}}

{{- define "FieldDoc" -}}
    {{- $indent := .indent -}}
    {{- $field := .field -}}
    {{- $parsed := .parsed -}}
    {{- if not ($parsed.ShouldDocumentField $field) -}}{{- /* skip undocumented fields */ -}}{{ end -}}
    {{ $indent }}"{{ $field.Desc.Name -}}":
    {{- if $field.Desc.IsList -}}
        [
        {{- if $field.Message -}}
            {{- $nestedIndent := printf "%s  " $indent -}}
            {{- $nestedParsed := parseLLMMessage $field.Message -}}
            {{ $nestedIndent }}{
            {{- template "MessageFieldsDoc" dict "message" $field.Message "indent" (printf "%s    " $indent) "parsed" $nestedParsed -}}
            {{ $nestedIndent }}}
        {{- else -}}
            {{ template "FieldTypeDoc" $field }}
        {{- end -}}
        ]
    {{- else if $field.Desc.IsMap -}}
        {
        {{ $indent }}  "key": {{ template "FieldTypeDoc" $field.Desc.MapKey }},
        {{ $indent }}  "value":
        {{- if $field.Desc.MapValue.Message -}}
            {
            {{- $nestedParsed := parseLLMMessage $field.Desc.MapValue.Message -}}
            {{- template "MessageFieldsDoc" dict "message" $field.Desc.MapValue.Message "indent" (printf "%s    " $indent) "parsed" $nestedParsed -}}
            {{ $indent }}  }
        {{- else -}}
            {{ template "FieldTypeDoc" $field.Desc.MapValue }}
        {{- end -}}
        {{ $indent }}}
    {{- else if $field.Message -}}
        {{- if eq $field.Message.Desc.FullName "google.protobuf.Timestamp" -}}
            {{ template "FieldTypeDoc" $field }}
        {{- else if eq $field.Message.Desc.FullName "google.type.PostalAddress" -}}
            {{- template "PostalAddressDoc" dict "indent" (printf "%s    " $indent) -}}
        {{- else if eq $field.Message.Desc.FullName "google.type.Date" -}}
            {{- template "DateDoc" dict "indent" (printf "%s    " $indent) -}}
        {{- else if eq $field.Message.Desc.FullName "google.type.TimeOfDay" -}}
            {{- template "TimeOfDayDoc" dict "indent" (printf "%s    " $indent) -}}
        {{- else -}}
            {{- $nestedParsed := parseLLMMessage $field.Message -}}
            {
            {{- template "MessageFieldsDoc" dict "message" $field.Message "indent" (printf "%s  " $indent) "parsed" $nestedParsed -}}
            {{ $indent }}}
        {{- end -}}
    {{- else -}}
        {{- template "FieldTypeDoc" $field -}}
    {{- end -}}
    {{ template "LeadingComment" $field.Comments.Leading }}
{{- end -}}

{{- define "MessageFieldsDoc" -}}
    {{-  if .parsed -}}
        {{- template "messageFieldsDoc" . -}}
    {{-  else -}}
        {{- .indent -}}// Fields not shown.
    {{- end -}}
{{-  end -}}

{{- define "messageFieldsDoc" -}}
    {{- $message := .message -}}
    {{- $indent := .indent -}}
    {{- $parsed := .parsed -}}
    {{- $processedOneofs := dict -}}
    {{- $firstField := true -}}
    {{- range $i, $field := $message.Fields -}}
        {{- if not ($parsed.ShouldDocumentField $field) -}}{{ continue }}{{- end -}}
        {{- if $field.Oneof -}}
            {{- $oneofName := $field.Oneof.Desc.Name | toString -}}
            {{- if not (index $processedOneofs $oneofName) -}}
                {{- $_ := set $processedOneofs $oneofName true -}}
                {{- /* Check if any oneof field is documented */ -}}
                {{- $hasVisibleOneofField := false -}}
                {{- range $oneofField := $field.Oneof.Fields -}}
                    {{- if $parsed.ShouldDocumentField $oneofField -}}
                        {{- $hasVisibleOneofField = true -}}
                    {{- end -}}
                {{- end -}}
                {{- if $hasVisibleOneofField -}}
                    {{- if not $firstField -}},{{ end -}}
                    {{- $firstField = false }}
                    {{- $indent }}// ONEOF: exactly one of the following must be set: [
                    {{- $firstOneof := true -}}
                    {{- range $j, $oneofField := $field.Oneof.Fields -}}
                        {{- if $parsed.ShouldDocumentField $oneofField -}}
                            {{- if not $firstOneof -}}, {{ end -}}{{ $oneofField.Desc.Name }}
                            {{- $firstOneof = false -}}
                        {{- end -}}
                    {{- end -}}]
                    {{- $firstOneofField := true -}}
                    {{- range $j, $oneofField := $field.Oneof.Fields -}}
                        {{- if $parsed.ShouldDocumentField $oneofField -}}
                            {{- if not $firstOneofField -}},{{ end -}}
                            {{- $firstOneofField = false -}}
                            {{ template "FieldDoc" dict "field" $oneofField "indent" $indent "parsed" $parsed -}}
                        {{- end -}}
                    {{- end }}
                {{- end -}}
            {{- end -}}
        {{- else -}}
            {{- if not $firstField -}},{{ end -}}
            {{- $firstField = false -}}
            {{- template "FieldDoc" dict "field" $field "indent" $indent "parsed" $parsed -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

// Code generated by protoc-templates. DO NOT EDIT.
// source: {{ $file.Desc.Path }}
package {{ if .PackageName }}{{ .PackageName }}{{ else }}{{ $goImportPath | base }}{{ end }}

{{- range $message := $file.Messages -}}
    {{- $parsed := parseLLMMessage $message -}}
    {{- if not $parsed -}}{{ continue }}{{- end }}

    {{- if $parsed.Generate }}
        func (m *{{ $message.GoIdent.GoName }}) LlmDoc() string {
        return `Structure for {{ $message.Desc.Name }}: {{ if $message.Comments.Leading }}{{ $message.Comments.Leading.String | trim }}{{ end }}
        {
        {{- template "MessageFieldsDoc" dict "message" $message "indent" "\n  " "parsed" $parsed }}
        }`}
    {{- end }}

    {{- if $parsed.FieldMaskPaths }}
        // LlmFieldMaskPaths returns the list of field paths that are documented for LLM consumption.
        func (m *{{ $message.GoIdent.GoName }}) LlmFieldMaskPaths() string {
        return "{{- range $i, $path := $parsed.FullFieldMaskPaths }}{{- if $i }},{{- end }}{{ $path }}{{- end }}"
        }
    {{- end }}
{{ end -}}
