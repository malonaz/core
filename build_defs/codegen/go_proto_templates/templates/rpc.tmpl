{{- /* ################### TOPLINE VARIABLES ################### */ -}}
{{ $file := .File }}
{{ $generatedFile := .GeneratedFile }}
{{- $apiImportPathRaw := $file.GoImportPath | toString | clean | dir -}}
{{- $apiImportPath := (trimPrefix "\"" $apiImportPathRaw) -}}
{{- $dummy := replaceImportPath $file.GoImportPath $apiImportPath -}}

// Code generated by protoc-templates. DO NOT EDIT.
// source: {{ $file.GoImportPath }}
package service

import (
pb "{{ $apiImportPath }}"
)


{{- range $service := $file.Services }}
    {{- range $method := $service.Methods }}
        {{ $rpc := parseRPC $method }}
        {{ if not $rpc }}{{ continue }}{{ end }}
        {{ $pr := $rpc.ParsedResource }}
        {{- $resourceGoName := $pr.Desc.Singular | camelcase }}
        {{- $softDeletable := $rpc.Message.Desc.Fields.ByName "delete_time" }}

        {{- $modelOpts := getExt $rpc.Message.Desc "malonaz.core.codegen.model.v1.model_opts" -}}
        {{- $dbClient := printf "%sDBClient" $modelOpts.DatabaseName -}}
        {{- $_ := fqn (printf "%s/model" ($rpc.Message.GoIdent.GoImportPath | toString | clean | replace "\"" "" | dir )) "" -}}

        {{- if $rpc.Create }}
            // {{ printf "Create%s creates a %s" $resourceGoName $resourceGoName }}
            func (s *Service) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *pb.{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            // STEP 1: Set identifiers.
            {{- if not $pr.Singleton }}
                {{ $pr.PatternVariable | camelcase | untitle }}Id := request.{{ $resourceGoName }}Id
                if {{ $pr.PatternVariable | camelcase | untitle }}Id == "" {
                {{ $pr.PatternVariable | camelcase | untitle }}Id = {{ fqn "github.com/malonaz/core/go/uuid" "MustNewV7" }}().String()
                }
            {{ end }}

            {{ if $pr.Parent }}
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}
            request.{{ $resourceGoName }}.Name = {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $pr.Pattern }}", {{ $pr.PatternVariableIDs true }})

            // STEP 2: Instantiate timestamps.
            {{ if $rpc.Message.Desc.Fields.ByName "create_time" -}}
                request.{{ $resourceGoName }}.CreateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
            {{ end -}}
            {{ if $rpc.Message.Desc.Fields.ByName "update_time" -}}
                request.{{ $resourceGoName }}.UpdateTime = request.{{ $resourceGoName }}.CreateTime
            {{ end -}}

            {{ "\n" }}
            // STEP 3: Convert the resource to the database representation.
            {{ $resourceGoName | untitle }}, err := model.{{ $resourceGoName }}FromPb(request.{{ $resourceGoName }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $resourceGoName | untitle }}: %v", err)
	          }

            {{- range $child := $pr.Children }}
                {{- if $child.Singleton }}
                    // Instantiate child singleton resource: {{ $child.Type }}
                    {{- $childMessage := getMessageUsingResourceType $child.Desc.Type }}
                    {{- $childResourceGoName := $child.Desc.Singular | camelcase -}}
                    {{- if not $childMessage }}
                        {{- fail (printf "could not find message for child resource type %s" $child.Desc.Type) }}
                    {{- end }}
                    {{ $childResourceGoName | untitle }} := &{{ qualifiedGoIdent $childMessage.GoIdent }}{
                    Name: {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $child.Pattern }}", {{ $child.PatternVariableIDs true }}),
                    CreateTime: request.{{ $resourceGoName }}.CreateTime,
                    UpdateTime: request.{{ $resourceGoName }}.UpdateTime,
                    }
                    {{ $childResourceGoName | untitle }}Db, err := model.{{ $childResourceGoName }}FromPb({{ $childResourceGoName | untitle }})
                    if err != nil {
		                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $childResourceGoName | untitle }}: %v", err)
	                  }

                {{ end }}
            {{ end }}

            {{ if $rpc.StandardMethod.EmitEvent }}
                var insertOpts []func({{ fqn "context" "Context" }}, {{ fqn "github.com/malonaz/core/go/postgres" "Tx" }}) error
                {// Emit event. {{ $rpc.Message.GoIdent.GoImportPath | toString | replace "\"" "" }}
                event := &{{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "%sCreatedEvent" $resourceGoName) }}{
                {{ $resourceGoName }}: request.{{ $resourceGoName }},
                }
                any, err := {{ fqn "google.golang.org/protobuf/types/known/anypb" "New" }}(event)
                if err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "creating anypb for event: %v", err)
                }
                bytes, err := {{ fqn "github.com/malonaz/core/go/pbutil" "Marshal" }}(any)
                if err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "marshaling created event: %v", err)
                }
                message := &{{ fqn "github.com/malonaz/pgq" "MessageOutgoing" }}{
                Payload: bytes,
                }
                publisher := {{ fqn "github.com/malonaz/pgq" "NewPublisher" }}(nil)
                insertOpt := func(ctx {{ fqn "context" "Context" }}, tx {{ fqn "github.com/malonaz/core/go/postgres" "Tx" }}) error {
                _, err := publisher.PublishInTx(ctx, tx, "job", message)
                return err
                }
                insertOpts = append(insertOpts, insertOpt)
                }
            {{ end }}
            // STEP 4: Insert the resource idempotently.
            ok, err := s.{{ $dbClient }}.Insert{{ $resourceGoName }}(ctx, {{ $resourceGoName | untitle }}{{ range $child := $pr.Children }}{{ if $child.Singleton }}, {{ $child.Desc.Singular | camelcase | untitle }}Db{{ end }}{{ end }}{{ if $rpc.StandardMethod.EmitEvent }}, insertOpts...{{ end }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $resourceGoName | snakecase }}: %v", err)
	          }
	          if !ok {
		        get{{ $resourceGoName }}Request := &pb.Get{{ $resourceGoName }}Request{ Name: request.{{ $resourceGoName }}.Name }
            var err error
            request.{{ $resourceGoName }}, err = s.Get{{ $resourceGoName }}(ctx, get{{ $resourceGoName }}Request)
            if err != nil {
            return nil, err
            }
            }

            return  request.{{ $resourceGoName }}, nil
            }

        {{- else if $rpc.Update }}
            var update{{ $resourceGoName }}RequestParser = {{ fqn "github.com/malonaz/core/go/aip" "NewUpdateRequestParser" }}(&pb.Update{{ $resourceGoName }}Request{})
            func (s *Service) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *pb.{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            // STEP 1: Parse request.
	          parsedRequest, err := update{{ $resourceGoName }}RequestParser.Parse(request.UpdateMask, request.{{ $resourceGoName }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing request: %v", err)
	          }

            // STEP 2: retrieve existing resource.
            get{{ $resourceGoName }}Request := &pb.Get{{ $resourceGoName }}Request{ Name: request.{{ $resourceGoName }}.Name }
            existing{{ $resourceGoName }}, err := s.Get{{ $resourceGoName }}(ctx, get{{ $resourceGoName }}Request)
            if err != nil {
            return nil, err
            }
            updated{{ $resourceGoName }} := {{ fqn "google.golang.org/protobuf/proto" "Clone" }}(existing{{ $resourceGoName }}).(*{{ qualifiedGoIdent $method.Output.GoIdent }})

            // STEP 3: Patch the existing resource.
            {{ if $rpc.Message.Desc.Fields.ByName "update_time" -}}
	              updated{{ $resourceGoName }}.UpdateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
            {{ end }}
	          if err := parsedRequest.ApplyFieldMask(updated{{ $resourceGoName }}, request.{{ $resourceGoName }}); err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "applying field mask: %v", err)
	          }

            // STEP 4: Insert patched resource.
	          {{ $resourceGoName | untitle }}, err := model.{{ $resourceGoName }}FromPb(updated{{ $resourceGoName }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting pb.{{ $resourceGoName }} to model.{{ $resourceGoName }}: %v", err)
	          }
	          ok, err := s.{{ $dbClient }}.Update{{ $resourceGoName }}(ctx, {{ $resourceGoName | untitle }}, parsedRequest.GetSQLUpsertClause())
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $resourceGoName | untitle }}: %v", err)
	          }
	          if !ok {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $resourceGoName | untitle }} does not exist")
	          }

            return updated{{ $resourceGoName }}, nil
            }

        {{- else if $rpc.Delete }}
            func (s *Service) Delete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *pb.Delete{{ $resourceGoName }}Request) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            // STEP 1: Parse resource name.
            {{ $pr.PatternVariableIDs true }}, err := model.Parse{{ $resourceGoName }}Name(request.Name)
            if err != nil {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            {{- if $softDeletable }}
                // STEP 2: Soft delete the resource.
                deleteTime := {{ fqn "time" "Now" }}()
                {{ $resourceGoName | untitle }}, ok, err := s.{{ $dbClient }}.SoftDelete{{ $resourceGoName }}(ctx, {{ $pr.PatternVariableIDs true }}, deleteTime)
                if err != nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "soft deleting {{ $resourceGoName | snakecase }}: %v", err)
                }
                if !ok {
                {{- if $method.Input.Desc.Fields.ByName "allow_missing" }}
                    if request.AllowMissing {
                    return &{{ qualifiedGoIdent $method.Output.GoIdent }}{Name: request.Name}, nil
                    }
                {{- end }}
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $resourceGoName | snakecase }} not found or already deleted")
                }

                // STEP 3: Convert to protobuf and return.
                pb{{ $resourceGoName }}, err := {{ $resourceGoName | untitle }}.ToPb()
                if err != nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting model.{{ $resourceGoName }} to pb.{{ $resourceGoName }}: %v", err)
                }

                return pb{{ $resourceGoName }}, nil
            {{ else }}
                // STEP 2: Hard delete the resource.
                ok, err := s.{{ $dbClient }}.Delete{{ $resourceGoName }}(ctx{{ range $id := $pr.PatternVariables true }}, {{ $id | camelcase | untitle }}ID{{ end }})
                if err != nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "deleting {{ $resourceGoName | snakecase }}: %v", err)
                }
                if !ok {
                {{- if $method.Input.Desc.Fields.ByName "allow_missing" }}
                    if request.AllowMissing {
                    return &{{ qualifiedGoIdent $method.Output.GoIdent }}{}, nil
                    }
                {{- end }}
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $resourceGoName | snakecase }} not found or already deleted")
                }

                return &{{ fqn "google.golang.org/protobuf/types/known/emptypb" "Empty" }}{}, nil
            {{ end }}
            }

        {{- else if $rpc.Get }}
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            func (s *Service) Get{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *pb.Get{{ $resourceGoName }}Request) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            if {{ fqn "go.einride.tech/aip/resourcename" "ContainsWildcard" }}(request.Name) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "cannot use wildcard")
            }

            {{ $pr.PatternVariableIDs true }}, err := model.Parse{{ $resourceGoName }}Name(request.Name)
            if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            // Retrieve from the database.
            {{ $resourceDbName }}, ok, err := s.{{ $dbClient }}.{{ $method.GoName }}(ctx, {{ $pr.PatternVariableIDs true }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "listing {{ $resourceGoName | snakecase }}: %v", err)
	          }
            if !ok {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "not found")
	          }

		        {{ $resourceGoName | untitle }}, err := {{ $resourceDbName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting model.{{ $resourceGoName }} to pb.{{ $resourceGoName }}: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.List }}
            var {{ $method.Input.GoIdent.GoName | untitle }}Parser = {{ fqn "github.com/malonaz/core/go/aip" "NewListRequestParser" }}(&pb.{{ $method.Input.GoIdent.GoName }}{})

            func (s *Service) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *pb.{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            {{ if $pr.Parent }}
                // Parse parent names
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}

            // Parse request
            parsed, err := {{ $method.Input.GoIdent.GoName | untitle }}Parser.ParseRequest(request)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, err.Error())
	          }
	          whereClause, whereParams := parsed.GetSQLWhereClause()
            var dbColumns []string

            // Retrieve from the database.
            {{ $resourceDbName }}s, err := s.{{ $dbClient }}.{{ $method.GoName }}(ctx, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }},{{ end }} {{ if $softDeletable }}request.ShowDeleted, {{ end }}whereClause, parsed.GetSQLOrderByClause(), parsed.GetSQLPaginationClause(), dbColumns, whereParams...)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "listing {{ $resourceGoName | snakecase }}: %v", err)
	          }
	          nextPageToken := parsed.GetNextPageToken(len({{ $resourceDbName }}s))
	          if nextPageToken != "" {
		        {{ $resourceDbName }}s = {{ $resourceDbName }}s[:len({{ $resourceDbName }}s)-1]
	          }

            // Convert back to proto.
            {{ $resourceGoName | untitle }}s := make([]*{{ qualifiedGoIdent $rpc.Message.GoIdent }}, 0, len({{ $resourceDbName }}s))
	          for _, {{ $resourceDbName }} := range {{ $resourceDbName }}s {
		        {{ $resourceGoName | untitle }}, err := {{ $resourceDbName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting model.{{ $resourceGoName }} to pb.{{ $resourceGoName }}: %v", err)
		        }
		        {{ $resourceGoName | untitle }}s = append({{ $resourceGoName | untitle }}s, {{ $resourceGoName | untitle }})
	          }

            // Create and return response.
            return &pb.{{ $method.Output.GoIdent.GoName }}{
            {{ $resourceGoName }}s: {{ $resourceGoName | untitle}}s,
            NextPageToken: nextPageToken,
            }, nil
            }
        {{ end -}}
    {{ end }}
{{- end }}
