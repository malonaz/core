{{- /* ################### TOPLINE VARIABLES ################### */ -}}
{{ $file := .File }}
{{ $generatedFile := .GeneratedFile -}}
{{- $modelGpi := .AdditionalGoImportPaths.model -}}

// Code generated by protoc-templates. DO NOT EDIT.
// source: {{ $file.Desc.Path }}
package {{ .PackageName }}

{{- $serviceInterfaces := dict }}
{{- range $service := $file.Services }}
    {{- $resourceList := list }}
    {{- range $method := $service.Methods }}
        {{- $rpc := parseRPC $method }}
        {{- if $rpc }}
            {{- $pr := $rpc.ParsedResource }}
            {{- $found := false }}
            {{- range $existingResource := $resourceList }}
                {{- if eq $existingResource.Desc.Singular $pr.Desc.Singular }}
                    {{- $found = true }}
                {{- end }}
            {{- end }}
            {{- if not $found }}
                {{- $resourceList = append $resourceList $pr }}
            {{- end }}
        {{- end }}
    {{- end }}
    {{- if gt (len $resourceList) 0 }}
        {{- $serviceName := $service.GoName }}
        {{- $serviceInterfaces = set $serviceInterfaces $serviceName $resourceList }}
    {{- end }}
{{- end }}

{{- range $serviceName, $resources := $serviceInterfaces }}
    type {{ $serviceName | untitle }}Store interface {
    {{- range $pr := $resources }}
        {{ $serviceName | untitle }}_{{ $pr.SingularGoName }}Store
    {{- end }}
    }

    type {{ $serviceName }}Server struct {
    {{- range $pr := $resources }}
        *{{ $serviceName | untitle }}_{{ $pr.SingularGoName }}Server
    {{- end }}
    }

    func New{{ $serviceName }}Server(store {{ $serviceName | untitle }}Store) *{{ $serviceName }}Server {
    return &{{ $serviceName }}Server{
    {{- range $pr := $resources }}
        new{{ $serviceName }}_{{ $pr.SingularGoName }}Server(store),
    {{- end }}
    }
    }
{{- end }}



{{- range $service := $file.Services }}
    {{- range $method := $service.Methods }}
        {{ $rpc := parseRPC $method }}
        {{ if not $rpc }}{{ continue }}{{ end }}
        {{ $pr := $rpc.ParsedResource }}
        {{ $storeInterface := printf "%s_%sStore" ($service.Desc.Name | toString | camelcase | untitle) $pr.SingularGoName }}
        {{- $resourceGoName := $pr.SingularGoName }}
        {{- $modelGoName := printf "%sModel" $resourceGoName }}
        {{ $goTypeQgi := $rpc.Message.GoIdent.GoName | $modelGpi.Ident | qgi }}
        {{ $parseFromPb := (printf "%sFromPb" $rpc.Message.GoIdent.GoName) | $modelGpi.Ident | qgi }}
        {{ $parseName := (printf "Parse%sName" $rpc.Message.GoIdent.GoName) | $modelGpi.Ident | qgi }}
        {{ $goType := $rpc.Message.GoIdent.GoName }}
        {{ $errNotExistFqi := (printf "Err%sNotExist" $goType) | $modelGpi.Ident | qgi }}
        {{ $errAlreadyExistsFqi := (printf "Err%sAlreadyExists" $goType) | $modelGpi.Ident | qgi }}
        {{ $errAlreadyDeletedFqi := (printf "Err%sAlreadyDeleted" $goType) | $modelGpi.Ident | qgi }}
        {{- $singletonChildren := list }}
        {{- range $childPr := $pr.Children }}
            {{- if $childPr.Singleton }}
	              {{- $childMessage := getMessageUsingResourceType $childPr.Desc.Type }}
	              {{- $modelOpts := getModelOpts $childMessage }}
                {{- if $modelOpts }}
                    {{- $singletonChildren = append $singletonChildren $childPr }}
                {{ end }}
            {{- end }}
        {{ end }}
        {{- $softDeletable := $rpc.Message.Desc.Fields.ByName "delete_time" }}
        {{- $modelOpts := getModelOpts $rpc.Message -}}
        {{ $hasRequestID := false }}
        {{- range $method := $service.Methods -}}
            {{ $rpc := parseRPC $method }}
            {{ if not $rpc }}{{ continue }}{{ end }}
            {{ if $rpc.Create }}
                {{ $hasRequestID = not (empty ($method.Input.Desc.Fields.ByName "request_id")) }}
                {{ break }}
            {{ end }}
        {{- end -}}

        {{/* SERVER STRUCT */}}
        {{- $serverGoName := printf "%s_%sServer" ($service.GoName | untitle) $resourceGoName }}
        {{ if doOnce (printf "%s_resource_interface_def" $pr.Desc.Singular) }}
            type {{ $storeInterface }} interface {
            {{ if not $pr.Singleton }}
                Insert{{ $resourceGoName }}{{ if $hasRequestID }}Idempotently{{ end }}(ctx {{ fqn "context" "Context" }}, {{ if $hasRequestID }}requestID string,{{ end }} {{ $resourceGoName | untitle }} *{{ $goTypeQgi }}{{ range $childPr := $singletonChildren }}, {{ $childPr.SingularGoName | untitle }} *{{ $childPr.SingularGoName | $modelGpi.Ident | qgi }}{{ end }}) (*{{ $goTypeQgi }}, error)
            {{ end }}
            Update{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $resourceGoName | untitle }} *{{ $goTypeQgi }}, updateClause string, columns []string) (*{{ $goTypeQgi }}, error)
            {{ if not $pr.Singleton }}
                {{- if $softDeletable }}
                    SoftDelete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string, deleteTime {{ fqn "time" "Time" }}) (*{{ $goTypeQgi }}, error)
                {{ else }}
                    Delete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string) error
                {{- end }}
            {{ end }}
            Get{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string) (*{{ $goTypeQgi }}, error)
            List{{ $pr.PluralGoName }}(ctx {{ fqn "context" "Context" }}, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }} string,{{ end }} {{ if $softDeletable }}showDeleted bool, {{ end }}whereClause, orderByClause, paginationClause string, dbColumns []string, whereParams ...any) ([]*{{ $goTypeQgi }}, error)
            }

            // Server implements the RPC interface.
            type {{ $serverGoName }} struct {
            store {{ $storeInterface }}
            }

            // Instantiate a new server.
            func new{{ $serverGoName | title }}(store {{ $storeInterface }}) *{{ $serverGoName }} {
            return &{{ $serverGoName }}{
            store: store,
            }
            }
        {{ end }}


        {{- if $rpc.Create }}
            // {{ printf "Create%s creates a %s" $resourceGoName $resourceGoName }}
            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
            // STEP 1: Set identifiers.
            {{ if $hasRequestID }}
                if request.RequestId == "" { // We always set a request id.
                request.RequestId = {{ fqn "github.com/malonaz/core/go/uuid" "MustNewV7" }}().String()
                }
            {{ end }}
            {{ $pr.PatternVariableID true }} := request.{{ $resourceGoName }}Id
            if {{ $pr.PatternVariableID true }} == "" {
            {{ $pr.PatternVariableID true }} = {{ fqn "github.com/malonaz/core/go/aip" "NewSystemGeneratedBase32ResourceID" }}()
            }

            {{ if $pr.Parent }}
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}
            request.{{ $resourceGoName }}.Name = {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $pr.Pattern }}", {{ $pr.PatternVariableIDs true }})

            // STEP 2: Instantiate timestamps.
            {{ if $rpc.Message.Desc.Fields.ByName "create_time" -}}
                // Check for override-create-time header
                if values := {{ fqn "google.golang.org/grpc/metadata" "ValueFromIncomingContext" }}(ctx, "override-create-time"); len(values) > 0 {
                if request.{{ $resourceGoName }}.CreateTime == nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "override-create-time used without setting a create_time")
                }
                } else {
                request.{{ $resourceGoName }}.CreateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
                }
            {{ end -}}
            {{ if $rpc.Message.Desc.Fields.ByName "update_time" -}}
                request.{{ $resourceGoName }}.UpdateTime = request.{{ $resourceGoName }}.CreateTime
            {{ end -}}

            {{ "\n" }}
            // STEP 3: Convert the resource to the database representation.
            {{ $modelGoName | untitle }}, err := {{ $parseFromPb }}(request.{{ $resourceGoName }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from pb to model: %v", err)
	          }

            {{- range $childPr := $singletonChildren }}
                // Instantiate child singleton resource: {{ $childPr.Type }}
                {{- $childMessage := getMessageUsingResourceType $childPr.Desc.Type }}
                {{- $childResourceGoName := $childPr.SingularGoName -}}
                {{- if not $childMessage }}
                    {{- fail (printf "could not find message for child resource type %s" $childPr.Desc.Type) }}
                {{- end }}
                {{ $childResourceGoName | untitle }} := &{{ qgi $childMessage.GoIdent }}{
                Name: {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $childPr.Pattern }}", {{ $childPr.PatternVariableIDs true }}),
                CreateTime: request.{{ $resourceGoName }}.CreateTime,
                UpdateTime: request.{{ $resourceGoName }}.UpdateTime,
                }
                {{ $parseFromPb := (printf "%sFromPb" $childMessage.GoIdent.GoName) | $modelGpi.Ident | qgi }}
                {{ $childResourceGoName | untitle }}Model, err := {{ $parseFromPb }}({{ $childResourceGoName | untitle }})
                if err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $childPr.Desc.Singular }} from pb to model: %v", err)
	              }
            {{ end }}

            {{- if $method.Input.Desc.Fields.ByName "validate_only" }}
                if request.ValidateOnly {
                return  request.{{ $resourceGoName }}, nil
                }
            {{- end }}

            // STEP 4: Insert the resource idempotently.
            db{{ $modelGoName }}, err := s.store.Insert{{ $resourceGoName }}{{ if $hasRequestID }}Idempotently{{ end }}(ctx, {{ if $hasRequestID }}request.RequestId,{{ end }} {{ $modelGoName | untitle }}{{ range $childPr := $singletonChildren }}, {{ $childPr.SingularGoName | untitle }}Model{{ end }})
            if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ $errAlreadyExistsFqi }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "AlreadyExists" }}, "{{ $pr.Desc.Singular }} already exists")
            }
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $resourceGoName | snakecase }}: %v", err)
	          }

            {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.Update }}
            var update{{ $resourceGoName }}RequestParser = {{ fqn "github.com/malonaz/core/go/aip" "MustNewUpdateRequestParser" }}[*{{ qgi $method.Input.GoIdent }}, *{{ qgi $rpc.Message.GoIdent }}]()
            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
            if {{ fqn "go.einride.tech/aip/resourcename" "ContainsWildcard" }}(request.{{ $resourceGoName }}.Name) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "cannot use wildcard")
            }

            {{- if $rpc.Message.Desc.Fields.ByName "update_time" }}
                // STEP 0: set the update time.
                request.UpdateMask.Paths = append(request.UpdateMask.Paths, "update_time")
	              request.{{ $resourceGoName }}.UpdateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
            {{- end }}

            // STEP 1: Parse request.
	          parsedRequest, err := update{{ $resourceGoName }}RequestParser.Parse(request)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing request: %v", err)
	          }

            // STEP 2: retrieve existing resource.
            get{{ $resourceGoName }}Request := &{{ (printf "Get%sRequest" $resourceGoName) | $file.GoImportPath.Ident | qgi }}{ Name: request.{{ $resourceGoName }}.Name }
            patched{{ $resourceGoName }}, err := s.Get{{ $resourceGoName }}(ctx, get{{ $resourceGoName }}Request)
            if err != nil {
            return nil, err
            }

            // STEP 3: Patch the existing resource.
	          if err := parsedRequest.ApplyFieldMask(patched{{ $resourceGoName }}, request.{{ $resourceGoName }}); err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "applying field mask: %v", err)
	          }

            // STEP 4: Insert patched resource.
	          {{ $modelGoName | untitle }}, err := {{ $parseFromPb }}(patched{{ $resourceGoName }})
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from pb to model: %v", err)
	          }
	          db{{ $modelGoName }}, err := s.store.Update{{ $resourceGoName }}(ctx, {{ $modelGoName | untitle }}, parsedRequest.GetSQLUpdateClause(), parsedRequest.GetSQLColumns())
            if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ $errNotExistFqi }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
            }
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $pr.Desc.Singular }}: %v", err)
            }

            {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.Delete }}
            func (s *{{ $serverGoName }}) Delete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
            // STEP 1: Parse resource name.
            {{ $pr.PatternVariableIDs true }}, err := {{ $parseName }}(request.Name)
            if err != nil {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            {{- if $softDeletable }}
                // STEP 2: Soft delete the resource.
                deleteTime := {{ fqn "time" "Now" }}()
                db{{ $modelGoName }}, err := s.store.SoftDelete{{ $resourceGoName }}(ctx, {{ $pr.PatternVariableIDs true }}, deleteTime)
                if err != nil {
                if {{ fqn "errors" "Is" }}(err, {{ $errNotExistFqi }}) {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
                }
                if {{ fqn "errors" "Is" }}(err, {{ $errAlreadyDeletedFqi }}) && !request.AllowMissing {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} already deleted")
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "soft deleting {{ $pr.Desc.Singular }}: %v", err)
                }

                // STEP 3: Convert to protobuf and return.
                {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
                if err != nil {
			          return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
                }
                return {{ $resourceGoName | untitle }}, nil

            {{ else }}
                // STEP 2: Hard delete the resource.
                if err := s.store.Delete{{ $resourceGoName }}(ctx{{ if $pr.PatternVariables }}, {{ $pr.PatternVariableIDs true }}{{ end }}); err != nil {
                if {{ fqn "errors" "Is" }}(err, {{ $errNotExistFqi }}) {
                if request.AllowMissing {
                return &{{ fqn "google.golang.org/protobuf/types/known/emptypb" "Empty" }}{}, nil
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "deleting {{ $pr.Desc.Singular }}: %v", err)
                }
                return &{{ fqn "google.golang.org/protobuf/types/known/emptypb" "Empty" }}{}, nil
            {{ end }}
            }

        {{- else if $rpc.Get }}
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            func (s *{{ $serverGoName }}) Get{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
            if {{ fqn "go.einride.tech/aip/resourcename" "ContainsWildcard" }}(request.Name) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "cannot use wildcard")
            }

            {{ $pr.PatternVariableIDs true }}, err := {{ $parseName }}(request.Name)
            if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            // Retrieve from the database.
            db{{ $modelGoName }}, err := s.store.{{ $method.GoName }}(ctx, {{ $pr.PatternVariableIDs true }})
	          if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ $errNotExistFqi }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
            }
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "getting {{ $pr.Desc.Singular }}: %v", err)
	          }

		        {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

{{- else if $rpc.BatchGet }}
    type resourceIdentifiers struct {
        {{- range $id := $pr.PatternVariables }}
        {{ $id | camelcase }}Id string
        {{- end }}
    }

func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
    {{ if $pr.Parent }}
        // Validate parent name.
        var {{ $pr.Parent.PatternVariableIDs true }} string
        if request.Parent != "" {
            if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
            }
        }
    {{ end }}

    // Validate and parse all names
    identifiers := make([]resourceIdentifiers, 0, len(request.Names))

    for _, name := range request.Names {
        if {{ fqn "go.einride.tech/aip/resourcename" "ContainsWildcard" }}(name) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "name cannot contain wildcard")
        }
        {{ if $pr.Parent }}
        if request.Parent != "" && !{{ fqn "go.einride.tech/aip/resourcename" "HasParent" }}(name, request.Parent) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "name %q does not have parent %q", name, request.Parent)
        }
        {{ end }}
        {{ $pr.PatternVariableIDs true }}, err := {{ $parseName }}(name)
        if err != nil {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name %s: %v", name, err)
        }
        identifiers = append(identifiers, resourceIdentifiers{
            {{- range $id := $pr.PatternVariables }}
            {{ $id | camelcase }}Id: {{ $id | camelcase | untitle }}Id,
            {{- end }}
        })
    }

    // Build WHERE clause for batch retrieval with OR conditions for each full resource identifier
    whereClauses := make([]string, len(identifiers))
    whereParams := make([]any, 0, len(identifiers) * {{ len $pr.PatternVariables }})

    for i, ids := range identifiers {
        conditions := make([]string, {{ len $pr.PatternVariables }})
        {{- range $idx, $id := $pr.PatternVariables }}
        {{- $dbColumn := $id }}
        {{- if and (eq $idx 0) $modelOpts.IdColumnName }}{{ $dbColumn = $modelOpts.IdColumnName }}{{ end }}
        conditions[{{ $idx }}] = "{{ $dbColumn | snakecase }}_id = $" + {{ fqn "strconv" "Itoa" }}(len(whereParams) + 1)
        whereParams = append(whereParams, ids.{{ $id | camelcase }}Id)
        {{- end }}
        whereClauses[i] = "(" + {{ fqn "strings" "Join" }}(conditions, " AND ") + ")"
    }
    whereClause := "WHERE " + {{ fqn "strings" "Join" }}(whereClauses, " OR ")

    // Retrieve from the database
    db{{ $modelGoName }}s, err := s.store.List{{ $pr.PluralGoName }}(ctx, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }},{{ end }} {{ if $softDeletable }}true, {{ end }}whereClause, "", "", nil, whereParams...)
    if err != nil {
        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "batch getting {{ $resourceGoName | snakecase }}: %v", err)
    }
    if len(db{{ $modelGoName }}s) != len(request.Names) {
       return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "expected %d {{ $pr.Desc.Plural }}, found %d", len(request.Names), len(db{{ $modelGoName }}s))
    }
    // Convert to proto
    {{ $resourceGoName | untitle }}NameTo{{ $resourceGoName }} := make(map[string]*{{ qgi $rpc.Message.GoIdent }}, len(request.Names))
    for _, db{{ $modelGoName }} := range db{{ $modelGoName }}s {
        {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
        if err != nil {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
        }
        {{ $resourceGoName | untitle }}NameTo{{ $resourceGoName }}[{{ $resourceGoName | untitle }}.Name] = {{ $resourceGoName | untitle }}
    }

    {{ $resourceGoName | untitle }}s := make([]*{{ qgi $rpc.Message.GoIdent }}, 0, len(db{{ $modelGoName }}s))
    for _, name := range request.Names {
       {{ $resourceGoName | untitle }}, ok := {{ $resourceGoName | untitle }}NameTo{{ $resourceGoName }}[name]
       if !ok {
          return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "could not find %q", name)
       }
       {{ $resourceGoName | untitle }}s = append({{ $resourceGoName | untitle }}s, {{ $resourceGoName | untitle }})
    }

    return &{{ qgi $method.Output.GoIdent }}{
        {{ $resourceGoName }}s: {{ $resourceGoName | untitle }}s,
    }, nil
}

        {{- else if $rpc.List }}
            var {{ $method.Input.GoIdent.GoName | untitle }}Parser = {{ fqn "github.com/malonaz/core/go/aip" "MustNewListRequestParser" }}[*{{ qgi $method.Input.GoIdent }}, *{{ qgi $rpc.Message.GoIdent }}]()

            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ qgi $method.Input.GoIdent }}) (*{{ qgi $method.Output.GoIdent }}, error) {
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            {{ if $pr.Parent }}
                // Parse parent names
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}

            // Parse request
            parsedRequest, err := {{ $method.Input.GoIdent.GoName | untitle }}Parser.Parse(request)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, err.Error())
	          }
	          whereClause, whereParams := parsedRequest.GetSQLWhereClause()
            var dbColumns []string

            // Retrieve from the database.
            {{ $resourceDbName }}s, err := s.store.{{ $method.GoName }}(ctx, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }},{{ end }} {{ if $softDeletable }}request.ShowDeleted, {{ end }}whereClause, parsedRequest.GetSQLOrderByClause(), parsedRequest.GetSQLPaginationClause(), dbColumns, whereParams...)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "listing {{ $resourceGoName | snakecase }}: %v", err)
	          }
	          nextPageToken := parsedRequest.GetNextPageToken(len({{ $resourceDbName }}s))
	          if nextPageToken != "" {
		        {{ $resourceDbName }}s = {{ $resourceDbName }}s[:len({{ $resourceDbName }}s)-1]
	          }

            // Convert back to proto.
            {{ $resourceGoName | untitle }}s := make([]*{{ qgi $rpc.Message.GoIdent }}, 0, len({{ $resourceDbName }}s))
	          for _, {{ $resourceDbName }} := range {{ $resourceDbName }}s {
		        {{ $resourceGoName | untitle }}, err := {{ $resourceDbName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting model.{{ $resourceGoName }} to {{ $resourceGoName }}: %v", err)
		        }
		        {{ $resourceGoName | untitle }}s = append({{ $resourceGoName | untitle }}s, {{ $resourceGoName | untitle }})
	          }

            // Create and return response.
            return &{{ qgi $method.Output.GoIdent }}{
            {{ $resourceGoName }}s: {{ $resourceGoName | untitle}}s,
            NextPageToken: nextPageToken,
            }, nil
            }
        {{ end -}}
    {{ end }}
{{- end }}
