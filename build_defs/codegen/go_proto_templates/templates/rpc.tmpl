{{- /* ################### TOPLINE VARIABLES ################### */ -}}
{{ $file := .File }}
{{ $generatedFile := .GeneratedFile }}

// Code generated by protoc-templates. DO NOT EDIT.
// source: {{ $file.Desc.Path }}
package {{ $file.GoPackageName }}

{{- $serviceInterfaces := dict }}
{{- range $service := $file.Services }}
    {{- $resourceList := list }}
    {{- range $method := $service.Methods }}
        {{- $rpc := parseRPC $method }}
        {{- if $rpc }}
            {{- $pr := $rpc.ParsedResource }}
            {{- $resourceKey := printf "%s" ($pr.Desc.Singular | camelcase) }}
            {{- $found := false }}
            {{- range $existingResource := $resourceList }}
                {{- if eq $existingResource.Desc.Singular $pr.Desc.Singular }}
                    {{- $found = true }}
                {{- end }}
            {{- end }}
            {{- if not $found }}
                {{- $resourceList = append $resourceList $pr }}
            {{- end }}
        {{- end }}
    {{- end }}
    {{- if gt (len $resourceList) 0 }}
        {{- $serviceName := $service.GoName }}
        {{- $serviceInterfaces = set $serviceInterfaces $serviceName $resourceList }}
    {{- end }}
{{- end }}

{{- range $serviceName, $resources := $serviceInterfaces }}
    type {{ $serviceName | untitle }}Store interface {
    {{- range $pr := $resources }}
        {{ $serviceName | untitle }}_{{ $pr.Desc.Singular | camelcase }}Store
    {{- end }}
    }

    type {{ $serviceName }}RpcServer struct {
    {{- range $pr := $resources }}
        *{{ $serviceName | untitle }}_{{ $pr.Desc.Singular | camelcase }}RpcServer
    {{- end }}
    }

    func New{{ $serviceName }}RpcServer(store {{ $serviceName | untitle }}Store) *{{ $serviceName }}RpcServer {
    return &{{ $serviceName }}RpcServer{
    {{- range $pr := $resources }}
        new{{ $serviceName }}_{{ $pr.Desc.Singular | camelcase }}RpcServer(store),
    {{- end }}
    }
    }
{{- end }}



{{- range $service := $file.Services }}
    {{- range $method := $service.Methods }}
        {{ $rpc := parseRPC $method }}
        {{ if not $rpc }}{{ continue }}{{ end }}
        {{ $pr := $rpc.ParsedResource }}
        {{ $storeInterface := printf "%s_%sStore" ($service.Desc.Name | toString | camelcase | untitle) ($pr.Desc.Singular | camelcase) }}
        {{- $resourceGoName := $pr.Desc.Singular | camelcase }}
        {{- $modelGoName := printf "%sModel" $resourceGoName }}
        {{- $singletonChildren := list }}
        {{- range $childPr := $pr.Children }}
            {{- if $childPr.Singleton }}
	              {{- $childMessage := getMessageUsingResourceType $childPr.Desc.Type }}
	              {{- $modelOpts := (getExt $childMessage.Desc "malonaz.codegen.model.v1.model_opts") }}
                {{- if $modelOpts.DatabaseName }}
                    {{- $singletonChildren = append $singletonChildren $childPr }}
                {{ end }}
            {{- end }}
        {{ end }}
        {{- $softDeletable := $rpc.Message.Desc.Fields.ByName "delete_time" }}
        {{- $modelOpts := getExt $rpc.Message.Desc "malonaz.codegen.model.v1.model_opts" -}}

        {{/* SERVER STRUCT */}}
        {{- $serverGoName := printf "%s_%sRpcServer" ($service.GoName | untitle) $resourceGoName }}
        {{ if doOnce (printf "%s_resource_interface_def" $pr.Desc.Singular) }}
            type {{ $storeInterface }} interface {
            {{ if not $pr.Singleton }}
                Insert{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, requestID string, {{ $resourceGoName | untitle }} *{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model{{ range $child := $singletonChildren }}, {{ $child.Desc.Singular | camelcase | untitle }} *{{ goIdent $rpc.Message.GoIdent.GoImportPath ($child.Desc.Singular | camelcase) }}Model{{ end }}) (*{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, error)
            {{ end }}
            Update{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $resourceGoName | untitle }} *{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, upsertClause string) (*{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, error)
            {{ if not $pr.Singleton }}
                {{- if $softDeletable }}
                    SoftDelete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string, deleteTime {{ fqn "time" "Time" }}) (*{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, error)
                {{ else }}
                    Delete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string) error
                {{- end }}
            {{ end }}
            Get{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, {{ $pr.PatternVariableIDs true }} string) (*{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, error)
            List{{ $pr.Desc.Plural | camelcase }}(ctx {{ fqn "context" "Context" }}, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }} string,{{ end }} {{ if $softDeletable }}showDeleted bool, {{ end }}whereClause, orderByClause, paginationClause string, dbColumns []string, whereParams ...any) ([]*{{ qualifiedGoIdent $rpc.Message.GoIdent }}Model, error)
            }

            // Server implements the RPC interface.
            type {{ $serverGoName }} struct {
            store {{ $storeInterface }}
            }

            // Instantiate a new server.
            func new{{ $serverGoName | title }}(store {{ $storeInterface }}) *{{ $serverGoName }} {
            return &{{ $serverGoName }}{
            store: store,
            }
            }
        {{ end }}


        {{- if $rpc.Create }}
            // {{ printf "Create%s creates a %s" $resourceGoName $resourceGoName }}
            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            // STEP 1: Set identifiers.
            if request.RequestId == "" { // We always set a request id.
            request.RequestId = {{ fqn "github.com/malonaz/core/go/uuid" "MustNewV7" }}().String()
            }
            {{ $pr.PatternVariable | camelcase | untitle }}Id := request.{{ $resourceGoName }}Id
            if {{ $pr.PatternVariable | camelcase | untitle }}Id == "" {
            {{ $pr.PatternVariable | camelcase | untitle }}Id = {{ fqn "github.com/malonaz/core/go/uuid" "MustNewV7" }}().String()
            }

            {{ if $pr.Parent }}
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}
            request.{{ $resourceGoName }}.Name = {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $pr.Pattern }}", {{ $pr.PatternVariableIDs true }})

            // STEP 2: Instantiate timestamps.
            {{ if $rpc.Message.Desc.Fields.ByName "create_time" -}}
                // Check for override-create-time header
                if values := {{ fqn "google.golang.org/grpc/metadata" "ValueFromIncomingContext" }}(ctx, "override-create-time"); len(values) > 0 {
                if request.{{ $resourceGoName }}.CreateTime == nil {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "override-create-time used without setting a create_time")
                }
                } else {
                request.{{ $resourceGoName }}.CreateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
                }
            {{ end -}}
            {{ if $rpc.Message.Desc.Fields.ByName "update_time" -}}
                request.{{ $resourceGoName }}.UpdateTime = request.{{ $resourceGoName }}.CreateTime
            {{ end -}}

            {{ "\n" }}
            // STEP 3: Convert the resource to the database representation.
            {{ $modelGoName | untitle }}, err := request.{{ $resourceGoName }}.ToModel()
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from pb to model: %v", err)
	          }

            {{- range $child := $singletonChildren }}
                // Instantiate child singleton resource: {{ $child.Type }}
                {{- $childMessage := getMessageUsingResourceType $child.Desc.Type }}
                {{- $childResourceGoName := $child.Desc.Singular | camelcase -}}
                {{- if not $childMessage }}
                    {{- fail (printf "could not find message for child resource type %s" $child.Desc.Type) }}
                {{- end }}
                {{ $childResourceGoName | untitle }} := &{{ qualifiedGoIdent $childMessage.GoIdent }}{
                Name: {{ fqn "go.einride.tech/aip/resourcename" "Sprint" }}("{{ $child.Pattern }}", {{ $child.PatternVariableIDs true }}),
                CreateTime: request.{{ $resourceGoName }}.CreateTime,
                UpdateTime: request.{{ $resourceGoName }}.UpdateTime,
                }
                {{ $childResourceGoName | untitle }}Model, err := {{ $childResourceGoName | untitle }}.ToModel()
                if err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $child.Desc.Singular }} from pb to model: %v", err)
	              }
            {{ end }}

            {{- if $method.Input.Desc.Fields.ByName "validate_only" }}
                if request.ValidateOnly {
                return  request.{{ $resourceGoName }}, nil
                }
            {{- end }}

            // STEP 4: Insert the resource idempotently.
            db{{ $modelGoName }}, err := s.store.Insert{{ $resourceGoName }}(ctx, request.RequestId, {{ $modelGoName | untitle }}{{ range $child := $singletonChildren }}, {{ $child.Desc.Singular | camelcase | untitle }}Model{{ end }})
            if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Err%sAlreadyExists" $modelGoName) }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "AlreadyExists" }}, "{{ $pr.Desc.Singular }} already exists")
            }
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $resourceGoName | snakecase }}: %v", err)
	          }

            {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.Update }}
            var update{{ $resourceGoName }}RequestParser = {{ fqn "github.com/malonaz/core/go/aip" "MustNewUpdateRequestParser" }}[*{{ $method.Input.GoIdent.GoName }}, *{{ qualifiedGoIdent $rpc.Message.GoIdent }}]()
            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            {{- if $rpc.Message.Desc.Fields.ByName "update_time" }}
                // STEP 0: set the update time.
                request.UpdateMask.Paths = append(request.UpdateMask.Paths, "update_time")
	              request.{{ $resourceGoName }}.UpdateTime = {{ fqn "google.golang.org/protobuf/types/known/timestamppb" "Now" }}()
            {{- end }}

            // STEP 1: Parse request.
	          parsedRequest, err := update{{ $resourceGoName }}RequestParser.Parse(request)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing request: %v", err)
	          }

            // STEP 2: retrieve existing resource.
            get{{ $resourceGoName }}Request := &Get{{ $resourceGoName }}Request{ Name: request.{{ $resourceGoName }}.Name }
            patched{{ $resourceGoName }}, err := s.Get{{ $resourceGoName }}(ctx, get{{ $resourceGoName }}Request)
            if err != nil {
            return nil, err
            }

            // STEP 3: Patch the existing resource.
	          if err := parsedRequest.ApplyFieldMask(patched{{ $resourceGoName }}, request.{{ $resourceGoName }}); err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "applying field mask: %v", err)
	          }

            // STEP 4: Insert patched resource.
	          {{ $modelGoName | untitle }}, err := patched{{ $resourceGoName }}.ToModel()
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from pb to model: %v", err)
	          }
	          db{{ $modelGoName }}, err := s.store.Update{{ $resourceGoName }}(ctx, {{ $modelGoName | untitle }}, parsedRequest.GetSQLUpsertClause())
            if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Err%sNotExist" $modelGoName) }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
            }
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "inserting {{ $pr.Desc.Singular }}: %v", err)
            }

            {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.Delete }}
            func (s *{{ $serverGoName }}) Delete{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *Delete{{ $resourceGoName }}Request) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            // STEP 1: Parse resource name.
            {{ $pr.PatternVariableIDs true }}, err := {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Parse%sName" $resourceGoName) }}(request.Name)
            if err != nil {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            {{- if $softDeletable }}
                // STEP 2: Soft delete the resource.
                deleteTime := {{ fqn "time" "Now" }}()
                db{{ $modelGoName }}, err := s.store.SoftDelete{{ $resourceGoName }}(ctx, {{ $pr.PatternVariableIDs true }}, deleteTime)
                if err != nil {
                if {{ fqn "errors" "Is" }}(err, {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Err%sNotExist" $modelGoName) }}) {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "soft deleting {{ $pr.Desc.Singular }}: %v", err)
                }
                if !db{{ $modelGoName }}.DeleteTime.Equal(deleteTime) && !request.AllowMissing {
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} is already soft deleted")
                }

                // STEP 3: Convert to protobuf and return.
                {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
                if err != nil {
			          return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
                }
                return {{ $resourceGoName | untitle }}, nil

            {{ else }}
                // STEP 2: Hard delete the resource.
                if err := s.store.Delete{{ $resourceGoName }}(ctx{{ range $id := $pr.PatternVariables }}, {{ $pr.PatternVariableIDs true }}{{ end }}); err != nil {
                if {{ fqn "errors" "Is" }}(err, {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Err%sNotExist" $modelGoName) }}) {
                if request.AllowMissing {
                return &{{ fqn "google.golang.org/protobuf/types/known/emptypb" "Empty" }}{}, nil
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
                }
                return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "deleting {{ $pr.Desc.Singular }}: %v", err)
                }
                return &{{ fqn "google.golang.org/protobuf/types/known/emptypb" "Empty" }}{}, nil
            {{ end }}
            }

        {{- else if $rpc.Get }}
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            func (s *{{ $serverGoName }}) Get{{ $resourceGoName }}(ctx {{ fqn "context" "Context" }}, request *Get{{ $resourceGoName }}Request) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            if {{ fqn "go.einride.tech/aip/resourcename" "ContainsWildcard" }}(request.Name) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "cannot use wildcard")
            }

            {{ $pr.PatternVariableIDs true }}, err := {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Parse%sName" $resourceGoName) }}(request.Name)
            if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "parsing name: %v", err)
            }

            // Retrieve from the database.
            db{{ $modelGoName }}, err := s.store.{{ $method.GoName }}(ctx, {{ $pr.PatternVariableIDs true }})
	          if err != nil {
            if {{ fqn "errors" "Is" }}(err, {{ goIdent $rpc.Message.GoIdent.GoImportPath (printf "Err%sNotExist" $modelGoName) }}) {
            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "NotFound" }}, "{{ $pr.Desc.Singular }} does not exist")
            }
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "getting {{ $pr.Desc.Singular }}: %v", err)
	          }

		        {{ $resourceGoName | untitle }}, err := db{{ $modelGoName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting {{ $pr.Desc.Singular }} from model to pb: %v", err)
		        }
            return {{ $resourceGoName | untitle }}, nil
            }

        {{- else if $rpc.List }}
            var {{ $method.Input.GoIdent.GoName | untitle }}Parser = {{ fqn "github.com/malonaz/core/go/aip" "MustNewListRequestParser" }}[*{{ $method.Input.GoIdent.GoName }}, *{{ qualifiedGoIdent $rpc.Message.GoIdent }}]()

            func (s *{{ $serverGoName }}) {{ $method.GoName }}(ctx {{ fqn "context" "Context" }}, request *{{ $method.Input.GoIdent.GoName }}) (*{{ qualifiedGoIdent $method.Output.GoIdent }}, error) {
            {{- $resourceDbName := printf "db%s" $resourceGoName }}
            {{ if $pr.Parent }}
                // Parse parent names
                var {{ $pr.Parent.PatternVariableIDs true }} string
                if err := {{ fqn "go.einride.tech/aip/resourcename" "Sscan" }}(request.Parent, "{{ $pr.Parent.Pattern }}", {{ $pr.Parent.PatternVariableIDPtrs }}); err != nil {
		            return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, "invalid parent name: %v", err)
                }
            {{ end }}

            // Parse request
            parsedRequest, err := {{ $method.Input.GoIdent.GoName | untitle }}Parser.Parse(request)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "InvalidArgument" }}, err.Error())
	          }
	          whereClause, whereParams := parsedRequest.GetSQLWhereClause()
            var dbColumns []string

            // Retrieve from the database.
            {{ $resourceDbName }}s, err := s.store.{{ $method.GoName }}(ctx, {{ if $pr.Parent }}{{ $pr.Parent.PatternVariableIDs true }},{{ end }} {{ if $softDeletable }}request.ShowDeleted, {{ end }}whereClause, parsedRequest.GetSQLOrderByClause(), parsedRequest.GetSQLPaginationClause(), dbColumns, whereParams...)
	          if err != nil {
		        return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "listing {{ $resourceGoName | snakecase }}: %v", err)
	          }
	          nextPageToken := parsedRequest.GetNextPageToken(len({{ $resourceDbName }}s))
	          if nextPageToken != "" {
		        {{ $resourceDbName }}s = {{ $resourceDbName }}s[:len({{ $resourceDbName }}s)-1]
	          }

            // Convert back to proto.
            {{ $resourceGoName | untitle }}s := make([]*{{ qualifiedGoIdent $rpc.Message.GoIdent }}, 0, len({{ $resourceDbName }}s))
	          for _, {{ $resourceDbName }} := range {{ $resourceDbName }}s {
		        {{ $resourceGoName | untitle }}, err := {{ $resourceDbName }}.ToPb()
		        if err != nil {
			      return nil, {{ fqn "google.golang.org/grpc/status" "Errorf" }}({{ fqn "google.golang.org/grpc/codes" "Internal" }}, "converting model.{{ $resourceGoName }} to {{ $resourceGoName }}: %v", err)
		        }
		        {{ $resourceGoName | untitle }}s = append({{ $resourceGoName | untitle }}s, {{ $resourceGoName | untitle }})
	          }

            // Create and return response.
            return &{{ $method.Output.GoIdent.GoName }}{
            {{ $resourceGoName }}s: {{ $resourceGoName | untitle}}s,
            NextPageToken: nextPageToken,
            }, nil
            }
        {{ end -}}
    {{ end }}
{{- end }}
