diff --git a/client/client.go b/client/client.go
index c1f404d..b497350 100644
--- a/client/client.go
+++ b/client/client.go
@@ -50,6 +50,8 @@ type Config struct {
 	preDialers  []PreDialer
 	inDecoders  map[string]iocodec.DecoderMaker
 	outEncoders map[string]iocodec.EncoderMaker
+
+	preOut func(v any) error
 }
 
 var DefaultConfig = &Config{
@@ -179,7 +181,16 @@ func RoundTrip(ctx context.Context, cfg *Config, fn func(grpc.ClientConnInterfac
 	}
 	defer cc.Close()
 
-	return fn(cc, in, out)
+	wrappedOut := out
+	if cfg.preOut != nil {
+		wrappedOut = func(v any) error {
+			if err := cfg.preOut(v); err != nil {
+				return err
+			}
+			return out(v)
+		}
+	}
+	return fn(cc, in, wrappedOut)
 }
 
 func (c *Config) makeDecoder() (iocodec.Decoder, error) {
diff --git a/client/options.go b/client/options.go
index c0a3f85..e84b301 100644
--- a/client/options.go
+++ b/client/options.go
@@ -113,3 +113,9 @@ func WithOutputEncoder(format string, maker iocodec.EncoderMaker) Option {
 		c.outEncoders = e
 	}
 }
+
+func WithOutputPreInterceptor(fn func(v any) error) Option {
+	return func(c *Config) {
+		c.preOut = fn
+	}
+}
diff --git a/cobra.go b/cobra.go
index ae0d087..675ad5a 100644
--- a/cobra.go
+++ b/cobra.go
@@ -95,7 +95,7 @@ func _{{.Parent.GoName}}{{.GoName}}Command(cfg *client.Config) *cobra.Command {
 			}
 			return client.RoundTrip(cmd.Context(), cfg, func(cc grpc.ClientConnInterface, in iocodec.Decoder, out iocodec.Encoder) error {
 				cli := New{{.Parent.GoName}}Client(cc)
-				v := &{{.Input.GoIdent.GoName}}{}
+				v := &{{.InputType}}{}
 	{{if .Desc.IsStreamingClient}}
 				stm, err := cli.{{.GoName}}(cmd.Context())
 				if err != nil {
@@ -239,6 +239,82 @@ func walkField(g *protogen.GeneratedFile, fld *protogen.Field, path, postSetCode
 	varName := "_" + strings.Join(path, "_")
 	oneof := fld.Oneof != nil && !fld.Oneof.Desc.IsSynthetic()
 
+	var oneofTarget string
+	if f := flagFormat(g, fld); f != "" {
+		var code []string
+		// Fixes issues where a oneof has a enum field.
+		specialCase := normalizeKind(fld.Desc.Kind()) == protoreflect.EnumKind && !fld.Desc.IsList()
+		if oneof {
+			oneofTarget = target  // Save the parent target
+			postSetCode = append(postSetCode, fmt.Sprintf("%s.%s = %s", oneofTarget, fld.Oneof.GoName, varName))
+			target = varName
+			if !specialCase {
+				code = append(code, fmt.Sprintf("%s := &%s{}", target, g.QualifiedGoIdent(fld.GoIdent)))
+			}
+		}
+
+		// Special handling for oneof enum pointer fields
+		if oneof && normalizeKind(fld.Desc.Kind()) == protoreflect.EnumKind && !fld.Desc.IsList() {
+			ptrVarName := varName + "Ptr"
+			code = append(code, fmt.Sprintf("var %s *%s", ptrVarName, g.QualifiedGoIdent(fld.Enum.GoIdent)))
+			code = append(code, fmt.Sprintf(f, "&"+ptrVarName, flagName, cleanComments(fld.Comments.Leading)))
+
+			// Update the last postSetCode entry to handle the pointer
+			postSetCode[len(postSetCode)-1] = fmt.Sprintf("%s.%s = &%s{%s: *%s}",
+				oneofTarget, fld.Oneof.GoName, g.QualifiedGoIdent(fld.GoIdent), fld.GoName, ptrVarName)
+		} else {
+			ptr := fmt.Sprintf("&%s.%s", target, fld.GoName)
+			code = append(code, fmt.Sprintf(f, ptr, flagName, cleanComments(fld.Comments.Leading)))
+		}
+
+		if len(postSetCode) > 0 {
+			code = append(code, fmt.Sprintf("flag.WithPostSetHook(cmd.PersistentFlags(), %s, func() { %s })", flagName, strings.Join(postSetCode, "; ")))
+		}
+		if deprecated || fld.Desc.Options().(*descriptorpb.FieldOptions).GetDeprecated() {
+			code = append(code, fmt.Sprintf("_ = cmd.PersistentFlags().MarkDeprecated(%s, \"deprecated\")", flagName))
+		}
+		return code
+	} else if normalizeKind(fld.Desc.Kind()) == protoreflect.MessageKind {
+		if fld.Desc.IsList() {
+			// message list not supported
+		} else if fld.Desc.IsMap() {
+			// limited map support
+		} else if visited[fld.Parent.GoIdent] = true; visited[fld.Message.GoIdent] {
+			// cycle detected
+		} else {
+			if oneof {
+				postSetCode = append(postSetCode, fmt.Sprintf("%s.%s = &%s{%s: %s}", target, fld.Oneof.GoName, g.QualifiedGoIdent(fld.GoIdent), fld.GoName, varName))
+			} else {
+				postSetCode = append(postSetCode, fmt.Sprintf("%s.%s = %s", target, fld.GoName, varName))
+			}
+			subVisited := make(map[protogen.GoIdent]bool, len(visited))
+			for k, v := range visited {
+				subVisited[k] = v
+			}
+			if subCode := walkMessage(g, fld.Message, path, postSetCode, deprecated, subVisited); len(subCode) > 0 {
+				code := []string{fmt.Sprintf("%s := &%s{}", varName, g.QualifiedGoIdent(fld.Message.GoIdent))}
+				if oneof {
+					code = append(code, fmt.Sprintf("cmd.PersistentFlags().Bool(%s, false, \"\")", flagName))
+					code = append(code, fmt.Sprintf("flag.WithPostSetHook(cmd.PersistentFlags(), %s, func() { %s })", flagName, strings.Join(postSetCode, "; ")))
+				}
+				return append(code, subCode...)
+			}
+		}
+	}
+
+	return nil
+}
+
+func walkFieldOld(g *protogen.GeneratedFile, fld *protogen.Field, path, postSetCode []string, deprecated bool, visited map[protogen.GoIdent]bool) []string {
+	target := "req"
+	if len(path) > 0 {
+		target = "_" + strings.Join(path, "_")
+	}
+	path = append(path, fld.GoName)
+	flagName := fmt.Sprintf("cfg.FlagNamer(%q)", strings.Join(path, " "))
+	varName := "_" + strings.Join(path, "_")
+	oneof := fld.Oneof != nil && !fld.Oneof.Desc.IsSynthetic()
+
 	if f := flagFormat(g, fld); f != "" {
 		var code []string
 		if oneof {
