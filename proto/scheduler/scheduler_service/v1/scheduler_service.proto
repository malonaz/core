syntax = "proto3";

package malonaz.core.scheduler.scheduler_service.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/api/client.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/field_mask.proto";
import "malonaz/core/codegen/aip/v1/aip.proto";
import "malonaz/core/scheduler/v1/job.proto";

option go_package = "github.com/malonaz/core/genproto/scheduler/scheduler_service/v1";

// This API represents a scheduler service.
//
// It defines the following resource model:
//
// - The API has a collection of Job resources.
service Scheduler {
  option (google.api.default_host) = "scheduler.malonaz.com";

  // Create a job.
  //
  // See: https://google.aip.dev/133 (Standard methods: Create).
  rpc CreateJob(CreateJobRequest) returns (malonaz.core.scheduler.v1.Job) {
    option (google.api.http) = {
      post: "/v1/job"
      body: "job"
    };
    option (google.api.method_signature) = "job";
    option (malonaz.core.codegen.aip.v1.standard_method).resource = "scheduler.malonaz.com/Job";
  }

  // Update a job.
  //
  // See: https://google.aip.dev/134 (Standard methods: Update).
  rpc UpdateJob(UpdateJobRequest) returns (malonaz.core.scheduler.v1.Job) {
    option (google.api.http) = {
      patch: "/v1/{job.name=jobs/*}"
      body: "job"
    };
    option (google.api.method_signature) = "job,update_mask";
    option (malonaz.core.codegen.aip.v1.standard_method).resource = "scheduler.malonaz.com/Job";
  }

  // Delete a job.
  //
  // See: https://google.aip.dev/135 (Standard methods: Delete).
  // See: https://google.aip.dev/164 (Soft delete).
  rpc DeleteJob(DeleteJobRequest) returns (malonaz.core.scheduler.v1.Job) {
    option (google.api.http) = {delete: "/v1/{name=jobs/*}"};
    option (google.api.method_signature) = "name";
    option (malonaz.core.codegen.aip.v1.standard_method).resource = "scheduler.malonaz.com/Job";
  }

  // Get a job.
  //
  // See: https://google.aip.dev/131 (Standard methods: Get).
  rpc GetJob(GetJobRequest) returns (malonaz.core.scheduler.v1.Job) {
    option (google.api.http) = {get: "/v1/{name=jobs/*}"};
    option (google.api.method_signature) = "name";
    option (malonaz.core.codegen.aip.v1.standard_method).resource = "scheduler.malonaz.com/Job";
  }

  // List jobs for a user.
  //
  // See: https://google.aip.dev/132 (Standard methods: List).
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse) {
    option (google.api.http) = {get: "/v1/jobs"};
    option (malonaz.core.codegen.aip.v1.standard_method).resource = "scheduler.malonaz.com/Job";
  }
}

// Request message for User.CreateJob.
message CreateJobRequest {
  // The ID to use for the resource, which will become the final component of
  // the resource name.
  //
  // This value should be 4-63 characters, and valid characters
  // are /[a-z][0-9]-/.
  string job_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The job to create.
  malonaz.core.scheduler.v1.Job job = 2 [(google.api.field_behavior) = REQUIRED];
}

// Request message for User.GetJob.
message GetJobRequest {
  // The resource name of the job to retrieve.
  // Format: jobs/{job}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference).type = "scheduler.malonaz.com/Job"
  ];
}

// Request message for User.UpdateJob.
message UpdateJobRequest {
  option (malonaz.core.codegen.aip.v1.update) = {
    default_paths: ["update_time"]
    path_mappings: [
      {
        from: "postal_address.*"
        to: ["postal_address"]
      }
    ]
    authorized_paths: []
  };
  option (buf.validate.message).cel = {
    id: "1"
    message: "job.name must be set"
    expression: "has(this.job.name)"
  };

  // The job to update with. The name must match or be empty.
  // The job's `name` field is used to identify the job to be updated.
  // Format: jobs/{job}
  malonaz.core.scheduler.v1.Job job = 1 [(buf.validate.field).ignore = IGNORE_ALWAYS];
  // The list of fields to update.
  google.protobuf.FieldMask update_mask = 2;
}

// Request message for User.DeleteJob.
message DeleteJobRequest {
  // The resource name of the job to delete.
  // Format: jobs/{job}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference).type = "scheduler.malonaz.com/Job"
  ];
  // If set to true, and the book is not found, the request will succeed
  // but no action will be taken on the server
  bool allow_missing = 2;
}

// Request message for User.ListJobs.
message ListJobsRequest {
  option (malonaz.core.codegen.aip.v1.list) = {
    default_page_size: 1000
    order_by: [
      "create_time",
      "update_time"
    ]
    filters: [
      {
        field: "create_time"
        well_known: TIMESTAMP
      },
      {
        field: "update_time"
        well_known: TIMESTAMP
      },
      {
        field: "delete_time"
        well_known: TIMESTAMP
      },
      {
        field: "phone_number"
        primitive: STRING
      },
      {
        field: "email_address"
        primitive: STRING
      },
      {
        field: "first_name"
        primitive: STRING
      },
      {
        field: "last_name"
        primitive: STRING
      }
    ]
  };

  // Requested page size. Server may return fewer users than requested.
  // If unspecified, server will pick an appropriate default.
  int32 page_size = 1 [(buf.validate.field).int32 = {
    gte: 0
    lte: 1000
  }];

  // A token identifying a page of results the server should return.
  // This is the value of
  // [ListJobsResponse.next_page_token][user.user_service.v1.ListJobsResponse.next_page_token]
  // returned from the previous call to `ListJobs` method.
  string page_token = 2;

  // Can order by...
  string order_by = 3;

  // Can filter on id, email_address, create_time, and update_time.
  string filter = 4;

  // If set to true, soft deleted resources will be shown.
  bool show_deleted = 5;
}

// Response message for User.ListJobs.
message ListJobsResponse {
  // The list of jobs.
  repeated malonaz.core.scheduler.v1.Job jobs = 1;
  // A token to retrieve next page of results.  Pass this value in the
  // [ListJobsRequest.page_token][user.user_service.v1.ListJobsRequest.page_token]
  // field in the subsequent call to `ListJobs` method to retrieve the next
  // page of results.
  string next_page_token = 2;
}
